<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>专 注专转 -  专专</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a',
            },
          },
          fontFamily: {
            heebo: ['Heebo', 'sans-serif'],
          },
          animation: {
            'fade-in': 'fadeIn 0.6s ease-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'bounce-star': 'bounceStar 0.3s ease-out',
            'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Heebo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #1e293b;
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
    }

    .dark body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #f1f5f9;
    }

    /* Enhanced Cards */
    .card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 20px 64px rgba(0, 0, 0, 0.08), 0 8px 32px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(16px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4, #10b981);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 32px 80px rgba(0, 0, 0, 0.12), 0 16px 48px rgba(0, 0, 0, 0.08);
    }

    .card:hover::before {
      opacity: 1;
    }

    .dark .card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.95) 100%);
      border-color: rgba(148, 163, 184, 0.2);
    }

    /* Enhanced Buttons */
    .btn {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      border: none;
      border-radius: 16px;
      padding: 16px 32px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
      min-height: 56px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s ease;
    }

    .btn:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 16px 48px rgba(59, 130, 246, 0.4);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:active {
      transform: translateY(-2px) scale(1.02);
    }

    .btn:disabled {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #64748b;
      box-shadow: 0 4px 16px rgba(100, 116, 139, 0.2);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      color: #475569;
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
    }

    /* Enhanced Inputs */
    .input, textarea {
      border: 2px solid transparent;
      border-radius: 16px;
      padding: 18px 24px;
      width: 100%;
      font-size: 16px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      color: #334155;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.04);
      font-family: 'Heebo', sans-serif;
    }

    .input:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.1), inset 0 2px 8px rgba(0, 0, 0, 0.04);
      transform: translateY(-2px);
    }

    .dark .input, .dark textarea {
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
      color: #f1f5f9;
      border-color: rgba(148, 163, 184, 0.2);
    }

    .dark .input:focus, .dark textarea:focus {
      background: #475569;
      border-color: #3b82f6;
    }

    /* Enhanced Stars */
    .star-car {
      font-size: 4rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: #d1d5db;
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.1));
      position: relative;
    }

    .star-car:hover {
      transform: scale(1.2) rotate(-5deg);
      filter: drop-shadow(0 8px 24px rgba(59, 130, 246, 0.4));
    }

    .star-car.active {
      color: #3b82f6;
      transform: scale(1.1);
      animation: bounceStar 0.4s ease-out;
    }

    .star-car.active::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.3) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: -1;
      animation: pulse-soft 2s ease-in-out infinite;
    }

    @keyframes bounceStar {
      0% { transform: scale(1); }
      50% { transform: scale(1.3) rotate(5deg); }
      100% { transform: scale(1.1); }
    }

    @keyframes pulseSoft {
      0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.2); }
    }

    /* Rating Display */
    .rating-display .star-car {
      font-size: 1.5rem;
      cursor: default;
      margin: 0 2px;
    }

    .rating-display .star-car:hover {
      transform: none;
      filter: none;
    }

    /* Reply System */
    .reply-box {
      border-right: 4px solid #e2e8f0;
      padding-right: 16px;
      margin-right: 8px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
    }

    .dark .reply-box {
      border-color: #374151;
      background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
    }

    .reply-depth-1 { margin-right: 20px; }
    .reply-depth-2 { margin-right: 40px; }
    .reply-depth-3 { margin-right: 60px; }

    /* User Badge */
    .user-badge {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* Loading States */
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 32px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 32px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-radius: 20px;
      padding: 20px 32px;
      font-weight: 700;
      box-shadow: 0 16px 48px rgba(16, 185, 129, 0.3);
      z-index: 9999;
      font-size: 16px;
      max-width: 90vw;
      text-align: center;
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: toastSlideIn 0.4s ease-out;
    }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    .slide-up {
      animation: slideUp 0.4s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(50px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .card {
        padding: 24px;
        border-radius: 20px;
        margin-bottom: 20px;
      }

      .star-car {
        font-size: 3rem;
      }

      .btn {
        padding: 14px 24px;
        font-size: 15px;
        border-radius: 12px;
        min-height: 52px;
      }

      .input, textarea {
        padding: 16px 20px;
        border-radius: 12px;
      }

      .reply-depth-1 { margin-right: 12px; }
      .reply-depth-2 { margin-right: 24px; }
      .reply-depth-3 { margin-right: 36px; }
    }

    @media (max-width: 480px) {
      .star-car {
        font-size: 2.5rem;
      }

      .card {
        padding: 20px;
        margin: 0 8px 16px 8px;
      }
    }

    /* Header Enhancements */
    .header-gradient {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
      position: relative;
      overflow: hidden;
    }

    .header-gradient::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a"><stop offset="20%" stop-color="%23fff" stop-opacity="0.1"/><stop offset="100%" stop-color="%23fff" stop-opacity="0"/></radialGradient></defs><circle r="50" cx="10" cy="10" fill="url(%23a)"/></svg>');
      opacity: 0.1;
    }

    /* Statistics Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.8) 100%);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .dark .stat-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.8) 100%);
      border-color: rgba(148, 163, 184, 0.2);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 900;
      color: #3b82f6;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
    }

    .dark .stat-label {
      color: #94a3b8;
    }
  </style>
</head>

<body class="dark:bg-gray-900">
  <!-- Header -->
  <header class="header-gradient text-white shadow-2xl">
    <div class="container mx-auto px-6 py-8">
      <div class="flex flex-col lg:flex-row justify-between items-center gap-6">
        <div class="flex items-center gap-4 text-center lg:text-right">
          <div class="bg-white/20 backdrop-blur-sm text-white p-4 rounded-2xl shadow-xl">
            <i class="fas fa-star text-3xl"></i>
          </div>
          <div>
            <h1 class="text-3xl md:text-4xl font-black mb-2">专 注专转</h1>
            <p class="text-lg opacity-90">转 注转 砖 砖  </p>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-3 w-full lg:w-auto">
          <a href="index.html" class="btn bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white border-2 border-white/30">
            <i class="fas fa-arrow-right"></i>
            专 注专转
          </a>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 max-w-5xl">
    <!-- Statistics Overview -->
    <div class="stats-grid mb-8">
      <div class="stat-card fade-in">
        <div class="stat-number" id="avgRating">0.0</div>
        <div class="stat-label">专 爪注</div>
      </div>
      <div class="stat-card fade-in" style="animation-delay: 0.1s;">
        <div class="stat-number" id="totalRatings">0</div>
        <div class="stat-label">住 专</div>
      </div>
      <div class="stat-card fade-in" style="animation-delay: 0.2s;">
        <div class="stat-number" id="fiveStarPercent">0%</div>
        <div class="stat-label">专 5 </div>
      </div>
    </div>

    <!-- Add Rating Form -->
    <div class="card mb-8 fade-in" style="animation-delay: 0.3s;">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-black text-gray-800 dark:text-gray-100 mb-4 flex items-center justify-center gap-3">
          <i class="fas fa-edit text-primary-600"></i>
          住祝 转 专 砖
        </h2>
        <p class="text-gray-600 dark:text-gray-400 text-lg">住驻专   砖转 注 注专转</p>
      </div>

      <div id="authMessage" class="hidden text-center bg-gradient-to-r from-yellow-50 to-amber-50 dark:from-yellow-900/20 dark:to-amber-900/20 border-2 border-yellow-300 dark:border-yellow-600 text-yellow-800 dark:text-yellow-200 p-6 rounded-2xl mb-6 shadow-lg" role="alert">
        <div class="flex items-center justify-center gap-3 mb-3">
          <i class="fas fa-exclamation-triangle text-2xl text-yellow-600"></i>
          <p class="font-bold text-xl">专砖转 转专转</p>
        </div>
        <p class="text-lg">注 专 祝 专砖 转专 注专转  砖转 住祝 专.</p>
        <a href="index.html" class="btn btn-secondary mt-4">
          <i class="fas fa-sign-in-alt"></i>
          转专 注转
        </a>
      </div>

      <form id="ratingForm" class="space-y-8" style="display: none;">
        <div class="text-center">
          <label class="block text-xl font-bold text-gray-700 dark:text-gray-300 mb-6">
             转 专 转 注专转?
          </label>
          <div class="flex items-center justify-center gap-4" id="carRating">
            <!-- Stars will be rendered here -->
          </div>
          <p class="text-gray-500 dark:text-gray-400 mt-4 text-lg" id="ratingText">专 专</p>
        </div>

        <div>
          <label for="ratingComment" class="block text-lg font-bold text-gray-700 dark:text-gray-300 mb-3">
            住驻专  转专 (驻爪)
          </label>
          <textarea 
            id="ratingComment" 
            rows="4" 
            class="input w-full text-lg" 
            placeholder=" 转 注专转?  驻砖专 砖驻专?  砖 注专  转  转专..."
          ></textarea>
        </div>

        <button type="submit" class="btn btn-success w-full text-xl py-6">
          <i class="fas fa-paper-plane text-xl"></i>
          砖 专
        </button>
      </form>

      <div id="ratingThanks" class="hidden text-center">
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-2 border-green-300 dark:border-green-600 text-green-800 dark:text-green-200 p-8 rounded-2xl shadow-lg">
          <i class="fas fa-check-circle text-4xl text-green-600 mb-4"></i>
          <h3 class="text-2xl font-bold mb-2">转 专!</h3>
          <p class="text-lg">专 砖 砖 爪 注专  砖转驻专</p>
        </div>
      </div>
    </div>

    <!-- Ratings List -->
    <div class="card fade-in" style="animation-delay: 0.4s;">
      <h3 class="text-3xl font-black text-gray-800 dark:text-gray-200 mb-8 flex items-center gap-3">
        <i class="fas fa-comments text-primary-600"></i>
        专 转转
        <span class="text-lg font-normal text-gray-500 dark:text-gray-400" id="ratingsCounter">(0)</span>
      </h3>
      
      <div id="ratingsList" class="space-y-6">
        <div class="text-center py-12">
          <div class="loading-spinner"></div>
          <p class="text-gray-500 dark:text-gray-400 mt-4 text-lg">注 专...</p>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs, doc,
      updateDoc, deleteDoc, getDoc, setDoc, where
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWOhJ4pSWnzMXOt8reavRWiLWtRS1ivzQ",
      authDomain: "my-driver-b0d00.firebaseapp.com",
      projectId: "my-driver-b0d00",
      storageBucket: "my-driver-b0d00.appspot.com",
      messagingSenderId: "752217263540",
      appId: "1:752217263540:web:2719a734580d03579eb6e1",
      measurementId: "G-2TCCSTYFL1"
    };

    // Firebase init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUser = null;
    const RATINGS_COLLECTION = "app_ratings";

    // Rating texts
    const ratingTexts = {
      1: " 专爪 ",
      2: " 转  转专 ",
      3: "住专 ",
      4: " ! ",
      5: "注! ぉ"
    };

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600' : ''}`;
      toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} ml-2"></i>${message}`;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Auth state management
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      document.getElementById("ratingForm").style.display = user ? 'block' : 'none';
      document.getElementById("authMessage").style.display = user ? 'none' : 'block';
      renderRatingsList();
      updateStatistics();
    });

    // Enhanced star rendering
    function renderCarRating(selected = 0) {
      const container = document.getElementById("carRating");
      const ratingText = document.getElementById("ratingText");
      
      container.innerHTML = "";
      
      for(let i = 1; i <= 5; i++) {
        const starWrapper = document.createElement("div");
        starWrapper.className = "relative";
        
        const star = document.createElement("i");
        star.className = `fas fa-car-side star-car ${i <= selected ? 'active' : ''}`;
        star.style.color = i <= selected ? '#3b82f6' : '#d1d5db';
        star.dataset.value = i;
        
        star.onclick = () => {
          renderCarRating(i);
          container.dataset.selected = i;
          ratingText.textContent = ratingTexts[i] || "专 专";
          ratingText.style.color = '#3b82f6';
          ratingText.style.fontWeight = '700';
        };
        
        starWrapper.appendChild(star);
        container.appendChild(starWrapper);
      }
      
      container.dataset.selected = selected;
      
      if (selected > 0) {
        ratingText.textContent = ratingTexts[selected];
        ratingText.style.color = '#3b82f6';
        ratingText.style.fontWeight = '700';
      } else {
        ratingText.textContent = "专 专";
        ratingText.style.color = '#64748b';
        ratingText.style.fontWeight = '400';
      }
    }

    // Enhanced form submission
    document.getElementById("ratingForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      if (!currentUser) {
        showToast("注 转专  专", 'error');
        return;
      }

      const rating = +document.getElementById("carRating").dataset.selected || 0;
      const comment = document.getElementById("ratingComment").value.trim();
      
      if (rating < 1 || rating > 5) {
        showToast("砖 专 专 砖 1-5 !", 'error');
        return;
      }

      const btn = e.target.querySelector("button[type='submit']");
      const originalContent = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = `<i class="fas fa-spinner fa-spin text-xl"></i> 砖 专...`;

      try {
        await addDoc(collection(db, RATINGS_COLLECTION), {
          rating,
          comment: comment || null,
          createdAt: serverTimestamp(),
          userId: currentUser.uid,
          userEmail: currentUser.email || "",
          userName: currentUser.displayName || currentUser.email?.split('@')[0] || '砖转砖'
        });

        document.getElementById("ratingForm").reset();
        renderCarRating(0);
        document.getElementById("ratingThanks").classList.remove("hidden");
        
        setTimeout(() => {
          document.getElementById("ratingThanks").classList.add("hidden");
        }, 4000);

        showToast("专 砖 爪! 转 专 ");
        renderRatingsList();
        updateStatistics();
        
      } catch (err) {
        console.error("Error submitting rating:", err);
        showToast("砖 砖转 专: " + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    });

    // Enhanced ratings list rendering
    async function renderRatingsList() {
      const box = document.getElementById("ratingsList");
      box.innerHTML = `
        <div class="text-center py-12">
          <div class="loading-spinner"></div>
          <p class="text-gray-500 dark:text-gray-400 mt-4 text-lg">注 专...</p>
        </div>
      `;

      try {
        const q = query(collection(db, RATINGS_COLLECTION), orderBy("createdAt", "desc"), limit(20));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          box.innerHTML = `
            <div class="text-center py-16">
              <i class="fas fa-star text-6xl text-gray-300 dark:text-gray-600 mb-6"></i>
              <h3 class="text-2xl font-bold text-gray-500 dark:text-gray-400 mb-4">注  专</h3>
              <p class="text-lg text-gray-400 dark:text-gray-500"> 专砖 专 转 注专转!</p>
            </div>
          `;
          document.getElementById("ratingsCounter").textContent = "(0)";
          return;
        }

        let html = "";
        let index = 0;
        
        for (const docSnap of snapshot.docs) {
          const r = docSnap.data();
          const ratingId = docSnap.id;
          const dateStr = r.createdAt?.toDate?.() ? relativeDate(r.createdAt.toDate()) : '驻  ';
          const commentSafe = r.comment ? escapeHtml(r.comment) : "";
          const userName = r.userName || r.userEmail?.split('@')[0] || '砖转砖 ';

          // Rating card with enhanced design
          html += `
            <div class="bg-gradient-to-r from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 slide-up" style="animation-delay: ${index * 0.1}s;">
              <div class="flex flex-col sm:flex-row gap-4">
                <!-- User Info & Rating -->
                <div class="flex-shrink-0 text-center sm:text-right">
                  <div class="user-badge mb-3">
                    <i class="fas fa-user"></i>
                    ${userName}
                  </div>
                  <div class="rating-display flex gap-1 justify-center sm:justify-start mb-2">
                    ${[1,2,3,4,5].map(i => `
                      <i class="fas fa-car-side star-car ${i <= r.rating ? 'text-yellow-400' : 'text-gray-300'}"></i>
                    `).join("")}
                  </div>
                  <div class="text-sm text-gray-500 dark:text-gray-400">${dateStr}</div>
                </div>

                <!-- Comment Content -->
                <div class="flex-1">
                  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div id="comment-content-${ratingId}" class="text-gray-700 dark:text-gray-300 text-lg leading-relaxed">
                      ${commentSafe || '<span class="text-gray-400 italic text-base">砖转砖  住祝 转</span>'}
                    </div>
                    
                    ${currentUser && currentUser.uid === r.userId ? `
                      <div class="flex gap-3 mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <button onclick="window.editRating('${ratingId}','${encodeURIComponent(r.comment||"")}')" class="btn-secondary text-sm py-2 px-4">
                          <i class="fas fa-edit"></i> 注专
                        </button>
                        <button onclick="window.deleteRating('${ratingId}')" class="btn-danger text-sm py-2 px-4">
                          <i class="fas fa-trash"></i> 拽
                        </button>
                      </div>
                    ` : ''}
                    
                    <div id="edit-area-${ratingId}" class="mt-4"></div>
                  </div>

                  <!-- Reply System -->
                  <div class="mt-4">
                    <button class="text-primary-600 dark:text-primary-400 text-sm font-semibold hover:text-primary-800 transition" onclick="window.toggleReplyInput('${ratingId}')">
                      <i class="fas fa-reply"></i>  专
                    </button>
                    
                    <div id="reply-input-${ratingId}" style="display:none;" class="mt-3">
                      <textarea class="input w-full text-sm" id="reply-textarea-${ratingId}" rows="2" placeholder="转 转..."></textarea>
                      <button class="btn text-sm mt-2" onclick="window.submitReply('${ratingId}', null)">
                        <i class="fas fa-paper-plane"></i> 砖 转
                      </button>
                    </div>
                    
                    <div id="replies-${ratingId}" class="mt-4"></div>
                  </div>
                </div>
              </div>
            </div>
          `;
          index++;
        }

        box.innerHTML = html;
        document.getElementById("ratingsCounter").textContent = `(${snapshot.docs.length})`;

        // Load replies for each rating
        for (const docSnap of snapshot.docs) {
          await loadReplies(docSnap.id, null, 0);
        }

      } catch (err) {
        console.error("Error loading ratings:", err);
        box.innerHTML = `
          <div class="text-center text-red-500 py-16">
            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
            <p class="text-xl">砖 注转 专: ${err.message}</p>
          </div>
        `;
      }
    }

    // Update statistics
    async function updateStatistics() {
      try {
        const q = query(collection(db, RATINGS_COLLECTION));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          document.getElementById("avgRating").textContent = "0.0";
          document.getElementById("totalRatings").textContent = "0";
          document.getElementById("fiveStarPercent").textContent = "0%";
          return;
        }

        let totalRating = 0;
        let fiveStarCount = 0;
        const totalCount = snapshot.docs.length;

        snapshot.docs.forEach(doc => {
          const rating = doc.data().rating || 0;
          totalRating += rating;
          if (rating === 5) fiveStarCount++;
        });

        const avgRating = (totalRating / totalCount).toFixed(1);
        const fiveStarPercent = Math.round((fiveStarCount / totalCount) * 100);

        document.getElementById("avgRating").textContent = avgRating;
        document.getElementById("totalRatings").textContent = totalCount.toString();
        document.getElementById("fiveStarPercent").textContent = `${fiveStarPercent}%`;

      } catch (err) {
        console.error("Error updating statistics:", err);
      }
    }

    // Helper functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function relativeDate(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      
      if (diff < 60) return "专注";
      if (diff < 3600) return `驻 ${Math.floor(diff / 60)} 拽转`;
      if (diff < 86400) return `驻 ${Math.floor(diff / 3600)} 砖注转`;
      if (diff < 2592000) return `驻 ${Math.floor(diff / 86400)} `;
      
      return date.toLocaleDateString('he-IL', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // Reply system functions
    window.loadReplies = async function(ratingId, parentId = null, depth = 0) {
      const repliesBox = parentId ? 
        document.getElementById(`replies-reply-${parentId}`) : 
        document.getElementById(`replies-${ratingId}`);
      
      if (!repliesBox) return;

      try {
        const repliesQuery = query(
          collection(db, RATINGS_COLLECTION, ratingId, "replies"),
          orderBy("createdAt", "asc")
        );
        const qSnap = await getDocs(repliesQuery);
        
        if (qSnap.empty) { 
          repliesBox.innerHTML = ""; 
          return; 
        }

        let html = "";
        for (const repDoc of qSnap.docs) {
          const rep = repDoc.data();
          const replyId = repDoc.id;
          const dateStr = rep.createdAt?.toDate?.() ? relativeDate(rep.createdAt.toDate()) : '';
          const replySafe = rep.content ? escapeHtml(rep.content) : "";
          const userName = rep.userName || rep.userEmail?.split('@')[0] || '砖转砖';

          html += `
            <div class="reply-box reply-depth-${Math.min(depth, 3)} slide-up">
              <div class="flex items-start gap-3">
                <div class="user-badge">
                  <i class="fas fa-user-circle"></i>
                  ${userName}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${dateStr}</div>
              </div>
              
              <div class="mt-3 text-gray-800 dark:text-gray-200" id="reply-content-${replyId}">
                ${replySafe}
              </div>
              
              <div class="flex gap-3 text-sm mt-3">
                <button onclick="window.toggleReplyInput('${ratingId}','${replyId}')" class="text-primary-600 dark:text-primary-400 hover:text-primary-800 transition">
                  <i class="fas fa-reply"></i> 
                </button>
                
                ${currentUser && currentUser.uid === rep.userId ? `
                  <button onclick="window.editReply('${ratingId}','${replyId}','${encodeURIComponent(rep.content||"")}')" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 transition">
                    <i class="fas fa-edit"></i> 注专
                  </button>
                  <button onclick="window.deleteReply('${ratingId}','${replyId}')" class="text-red-600 hover:text-red-800 transition">
                    <i class="fas fa-trash"></i> 拽
                  </button>
                ` : ''}
              </div>
              
              <div id="reply-input-${ratingId}-${replyId}" style="display:none;" class="mt-3">
                <textarea class="input w-full text-sm" id="reply-textarea-${ratingId}-${replyId}" rows="2" placeholder=" 转..."></textarea>
                <button class="btn text-sm mt-2" onclick="window.submitReply('${ratingId}','${replyId}')">
                  <i class="fas fa-paper-plane"></i> 砖 转
                </button>
              </div>
              
              <div id="edit-area-reply-${replyId}"></div>
              <div id="replies-reply-${replyId}" class="mt-3"></div>
            </div>
          `;
        }

        repliesBox.innerHTML = html;

        // Load nested replies
        for (const repDoc of qSnap.docs) {
          await loadReplies(ratingId, repDoc.id, depth + 1);
        }

      } catch (err) {
        console.error("Error loading replies:", err);
        repliesBox.innerHTML = `<div class="text-red-400 text-sm">砖 注转 转转</div>`;
      }
    };

    window.toggleReplyInput = function(ratingId, replyId = null) {
      const id = replyId ? `reply-input-${ratingId}-${replyId}` : `reply-input-${ratingId}`;
      const box = document.getElementById(id);
      if (!box) return;
      
      box.style.display = box.style.display === "none" ? "block" : "none";
      
      if (box.style.display === "block") {
        const textarea = box.querySelector('textarea');
        if (textarea) {
          textarea.focus();
        }
      }
    };

    window.submitReply = async function(ratingId, parentReplyId = null) {
      if (!currentUser) {
        showToast("砖 转专  ", 'error');
        return;
      }

      const textId = parentReplyId ? 
        `reply-textarea-${ratingId}-${parentReplyId}` : 
        `reply-textarea-${ratingId}`;
      
      const textarea = document.getElementById(textId);
      const content = textarea.value.trim();
      
      if (!content) {
        showToast("砖  转 转", 'error');
        return;
      }

      try {
        const replyData = {
          content,
          userId: currentUser.uid,
          userEmail: currentUser.email || "",
          userName: currentUser.displayName || currentUser.email?.split('@')[0] || '砖转砖',
          createdAt: serverTimestamp(),
          parent: parentReplyId || null
        };

        await addDoc(collection(db, RATINGS_COLLECTION, ratingId, "replies"), replyData);
        
        textarea.value = "";
        window.toggleReplyInput(ratingId, parentReplyId);
        
        showToast("转 砖 爪!");
        await loadReplies(ratingId, parentReplyId);
        
      } catch(err) {
        console.error("Error submitting reply:", err);
        showToast("砖 砖转 转: " + err.message, 'error');
      }
    };

    // Edit and delete functions
    window.editRating = function(ratingId, oldCommentEnc) {
      const areaId = `edit-area-${ratingId}`;
      const area = document.getElementById(areaId);
      if (!area) return;
      
      area.innerHTML = `
        <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-4 border-2 border-primary-200 dark:border-primary-700">
          <textarea id="edit-rating-textarea-${ratingId}" class="input w-full" rows="3" placeholder="注专 转 转...">${decodeURIComponent(oldCommentEnc || "")}</textarea>
          <div class="flex gap-2 mt-3">
            <button class="btn text-sm" onclick="window.saveEditRating('${ratingId}')">
              <i class="fas fa-save"></i> 砖专 砖
            </button>
            <button class="btn-secondary text-sm" onclick="window.cancelEdit('${areaId}')">
              <i class="fas fa-times"></i> 
            </button>
          </div>
        </div>
      `;
      
      document.getElementById(`edit-rating-textarea-${ratingId}`).focus();
    };

     window.saveEditRating = async function(ratingId) {
      const txt = document.getElementById(`edit-rating-textarea-${ratingId}`);
      if (!txt) return;
      
      const content = txt.value.trim();
      
      try {
        await updateDoc(doc(db, RATINGS_COLLECTION, ratingId), { 
          comment: content || null 
        });
        
        document.getElementById(`comment-content-${ratingId}`).innerHTML = 
          content ? escapeHtml(content) : '<span class="text-gray-400 italic text-base">砖转砖  住祝 转</span>';
        
        window.cancelEdit(`edit-area-${ratingId}`);
        showToast("转 注 爪!");
        
      } catch (err) {
        console.error("Error updating rating:", err);
        showToast("砖 砖专: " + err.message, 'error');
      }
    };

    window.deleteRating = async function(ratingId) {
      if (!confirm(" 转  砖专爪 拽 转 专? 驻注   转转 .")) return;
      
      try {
        await deleteDoc(doc(db, RATINGS_COLLECTION, ratingId));
        showToast("专 拽 爪");
        renderRatingsList();
        updateStatistics();
        
      } catch (err) {
        console.error("Error deleting rating:", err);
        showToast("砖 拽: " + err.message, 'error');
      }
    };

    window.editReply = function(ratingId, replyId, oldContentEnc) {
      const areaId = `edit-area-reply-${replyId}`;
      const area = document.getElementById(areaId);
      if (!area) return;
      
      area.innerHTML = `
        <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-4 border-2 border-primary-200 dark:border-primary-700 mt-3">
          <textarea id="edit-reply-textarea-${replyId}" class="input w-full text-sm" rows="2" placeholder="注专 转 转...">${decodeURIComponent(oldContentEnc || "")}</textarea>
          <div class="flex gap-2 mt-3">
            <button class="btn text-sm" onclick="window.saveEditReply('${ratingId}','${replyId}')">
              <i class="fas fa-save"></i> 砖专
            </button>
            <button class="btn-secondary text-sm" onclick="window.cancelEdit('${areaId}')">
              <i class="fas fa-times"></i> 
            </button>
          </div>
        </div>
      `;
      
      document.getElementById(`edit-reply-textarea-${replyId}`).focus();
    };

    window.saveEditReply = async function(ratingId, replyId) {
      const txt = document.getElementById(`edit-reply-textarea-${replyId}`);
      if (!txt) return;
      
      const content = txt.value.trim();
      if (!content) {
        showToast("转   转 专拽", 'error');
        return;
      }
      
      try {
        await updateDoc(doc(db, RATINGS_COLLECTION, ratingId, "replies", replyId), { 
          content 
        });
        
        document.getElementById(`reply-content-${replyId}`).innerHTML = escapeHtml(content);
        window.cancelEdit(`edit-area-reply-${replyId}`);
        showToast("转 注 爪!");
        
      } catch (err) {
        console.error("Error updating reply:", err);
        showToast("砖 砖专: " + err.message, 'error');
      }
    };

    window.deleteReply = async function(ratingId, replyId) {
      if (!confirm(" 拽 转 ? 驻注   转转 .")) return;
      
      try {
        await deleteDoc(doc(db, RATINGS_COLLECTION, ratingId, "replies", replyId));
        showToast("转 拽 爪");
        await loadReplies(ratingId, null);
        
      } catch (err) {
        console.error("Error deleting reply:", err);
        showToast("砖 拽转 转: " + err.message, 'error');
      }
    };

    window.cancelEdit = function(areaId) {
      const area = document.getElementById(areaId);
      if (area) area.innerHTML = "";
    };

    // Dark mode support
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }

    // Initialize when DOM is ready
    document.addEventListener("DOMContentLoaded", () => {
      renderCarRating(0);
      renderRatingsList();
      updateStatistics();
      
      // Add smooth scroll behavior
      document.documentElement.style.scrollBehavior = 'smooth';
    });

    // Handle theme changes from parent window
    window.addEventListener('storage', function(e) {
      if (e.key === 'theme') {
        if (e.newValue === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }
    });

  </script>
</body>
</html>