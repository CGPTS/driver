<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>

<!-- Favicon והגדרות PWA -->
<link rel="icon" href="favicon.ico" sizes="any">
<link rel="icon" href="favicon-192x192.png" sizes="192x192" type="image/png">
<link rel="apple-touch-icon" href="favicon-512x512.png">
<meta name="theme-color" content="#3b82f6">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="יומן הדרייבר">
<link rel="manifest" href="site.webmanifest">

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>יומן הדרייבר</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe', 
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                    },
                    fontFamily: {
                        heebo: ['Heebo', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-soft': 'pulse 2s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/he.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
<style>
    /* Reset & Base */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Heebo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: #1e293b;
        min-height: 100vh;
        line-height: 1.6;
        overflow-x: hidden;
    }

    /* Enhanced Cards */
    .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(8px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12), 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .card:hover::before {
        opacity: 1;
    }

    /* Enhanced Buttons */
    .btn {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border: none;
        border-radius: 16px;
        padding: 16px 32px;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
        position: relative;
        overflow: hidden;
        min-height: 56px;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.6s ease;
    }

    .btn:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 16px 48px rgba(59, 130, 246, 0.4);
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn:active {
        transform: translateY(-2px) scale(1.02);
    }

    .btn:disabled {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-secondary {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        color: #64748b;
        box-shadow: 0 4px 16px rgba(100, 116, 139, 0.2);
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        color: #475569;
    }

    .btn-secondary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
    }

    .btn-secondary:hover::before {
        left: 100%;
    }

    /* Enhanced Inputs */
    .input,
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    input[type="tel"],
    select {
        border: 2px solid transparent;
        border-radius: 16px;
        padding: 18px 24px;
        width: 100%;
        font-size: 16px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        color: #334155;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.04);
        font-family: 'Heebo', sans-serif;
    }

    .input:focus,
    input:focus,
    select:focus {
        outline: none;
        border-color: #3b82f6;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.1), inset 0 2px 8px rgba(0, 0, 0, 0.04);
        transform: translateY(-2px);
    }

    /* Enhanced Modals - מותאם למובייל */
    .modal-backdrop {
        background: rgba(15, 23, 42, 0.6);
        position: fixed;
        inset: 0;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        z-index: 50;
        padding: 10px;
        backdrop-filter: blur(8px);
        opacity: 0;
        animation: fadeIn 0.3s ease-out forwards;
        overflow-y: auto;
        max-height: 100vh;
    }

    .modal {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
        border-radius: 24px;
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2), 0 8px 24px rgba(0, 0, 0, 0.08);
        padding: 24px;
        max-width: 28rem;
        width: 100%;
        margin: 10px auto;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(16px);
        transform: scale(0.9);
        animation: modalSlideIn 0.3s ease-out forwards;
        max-height: calc(100vh - 20px);
        overflow-y: auto;
    }

    @keyframes modalSlideIn {
        to {
            transform: scale(1);
        }
    }

    /* Payment Badges */
    .payment-badge {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        color: #3730a3;
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 8px rgba(55, 48, 163, 0.15);
        border: 1px solid rgba(55, 48, 163, 0.1);
    }

    .payment-badge-bit {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
    }

    .payment-badge-cash {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #166534;
    }

    .payment-badge-paybox {
        background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
        color: #7c2d12;
    }

    .payment-badge-note {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
    }

    /* Enhanced Table */
    .table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        background: white;
    }

    .table thead th {
        text-align: right;
        padding: 20px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: #1e40af;
        font-weight: 800;
        font-size: 14px;
        border-bottom: 2px solid #e2e8f0;
        letter-spacing: 0.025em;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table td {
        padding: 16px 20px;
        border-bottom: 1px solid #f1f5f9;
        background: rgba(255, 255, 255, 0.98);
        font-size: 14px;
        vertical-align: middle;
    }

    .table tr:last-child td {
        border-bottom: none;
    }

    .table tbody tr {
        transition: all 0.2s ease;
    }

    .table tbody tr:hover {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%) !important;
        transform: scale(1.01);
    }

    /* Loading States */
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Toast Notifications */
    .toast {
        position: fixed;
        top: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-radius: 16px;
        padding: 16px 24px;
        font-weight: 600;
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        z-index: 9999;
        font-size: 14px;
        max-width: 90vw;
        text-align: center;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: toastSlideIn 0.3s ease-out;
    }

    @keyframes toastSlideIn {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    /* Calendar Enhancements */
    .flatpickr-day {
        border-radius: 8px !important;
        transition: all 0.2s ease !important;
        position: relative;
        min-height: 40px !important;
        height: 40px !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center;
        justify-content: flex-start;
        line-height: 1.2 !important;
        padding-top: 4px !important;
    }

    .flatpickr-day.day-with-rides {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%) !important;
        color: #166534 !important;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(22, 101, 52, 0.2);
    }

    .flatpickr-day.day-without-rides {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
        color: #dc2626 !important;
        opacity: 0.8;
    }

    .flatpickr-day.selected {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
        border-color: #1d4ed8 !important;
        box-shadow: 0 4px 16px rgba(29, 78, 216, 0.4) !important;
    }

    .calendar-amount {
        display: block;
        margin-top: 2px;
        font-size: 9px;
        line-height: 1;
        font-weight: 600;
        opacity: 0.8;
    }

    .flatpickr-day.day-without-rides .calendar-amount {
        color: #dc2626;
    }

    .flatpickr-day.day-with-rides .calendar-amount {
        color: #166534;
    }

    .flatpickr-day.day-future .calendar-amount {
        color: #888;
        opacity: 0.7;
    }

    .flatpickr-calendar .flatpickr-days,
    .flatpickr-calendar .flatpickr-weekdays {
        min-width: 280px !important;
    }

    .flatpickr-calendar .flatpickr-weekdays {
        display: flex !important;
        flex-direction: row-reverse !important;
    }

    .flatpickr-calendar .flatpickr-weekday {
        flex: 1 1 0;
        text-align: center;
        direction: rtl !important;
    }

    /* Dark Mode Enhancements */
    .dark body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #f1f5f9;
    }

    .dark .card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.9) 100%);
        border-color: rgba(148, 163, 184, 0.1);
    }

    .dark .modal {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.95) 100%);
        border-color: rgba(148, 163, 184, 0.2);
    }

    .dark .table thead th {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: #60a5fa;
    }

    .dark .table td {
        background: rgba(30, 41, 59, 0.6);
        border-color: rgba(148, 163, 184, 0.1);
    }

    .dark .table tbody tr:hover {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%) !important;
        color: #f1f5f9;
    }

    .dark .input,
    .dark input,
    .dark select {
        background: linear-gradient(135deg, #334155 0%, #475569 100%);
        color: #f1f5f9;
        border-color: rgba(148, 163, 184, 0.2);
    }

    .dark .input:focus,
    .dark input:focus,
    .dark select:focus {
        background: #475569;
        border-color: #3b82f6;
    }

    .dark .payment-badge {
        background: linear-gradient(135deg, #334155 0%, #475569 100%);
        color: #cbd5e1;
    }

    .dark .payment-badge-bit {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: #dbeafe;
    }

    .dark .payment-badge-cash {
        background: linear-gradient(135deg, #166534 0%, #16a34a 100%);
        color: #dcfce7;
    }

    .dark .payment-badge-paybox {
        background: linear-gradient(135deg, #7c2d12 0%, #a16207 100%);
        color: #fef3c7;
    }

    .dark .payment-badge-note {
        background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        color: #fee2e2;
    }

    /* Responsive Enhancements */
    @media (max-width: 768px) {
        .modal-backdrop {
            padding: 5px;
            align-items: flex-start;
        }
        
        .modal {
            padding: 16px;
            border-radius: 16px;
            max-width: calc(100vw - 10px);
            margin: 5px auto;
            max-height: calc(100vh - 10px);
            width: calc(100% - 10px);
        }
        
        .modal .space-y-6 > * + * {
            margin-top: 1rem;
        }
        
        .card {
            padding: 16px;
            border-radius: 16px;
        }

        .btn {
            padding: 14px 24px;
            font-size: 15px;
            border-radius: 12px;
            min-height: 52px;
        }
        
        .input {
            padding: 16px 20px;
            border-radius: 12px;
        }

        .table th,
        .table td {
            padding: 12px 8px;
            font-size: 13px;
        }

        .flatpickr-day {
            min-height: 35px !important;
            height: 35px !important;
        }

        .calendar-amount {
            font-size: 8px;
        }

        /* תיקון עבור מודל נסיעה גדול */
        #rideModal .modal {
            max-width: calc(100vw - 10px);
            max-height: calc(100vh - 10px);
            overflow-y: auto;
        }
        
        #rideModal .grid {
            grid-template-columns: 1fr;
        }
        
        #payment-splits .flex {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        #payment-splits .payment-method,
        #payment-splits .payment-amount,
        #payment-splits .payment-note {
            flex: none;
            width: 100%;
        }
    }

    /* Micro-interactions */
    .clickable {
        cursor: pointer;
        transition: transform 0.1s ease;
    }

    .clickable:active {
        transform: scale(0.98);
    }

    /* Scroll Enhancements */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(148, 163, 184, 0.1);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    }

    /* Animation Classes */
    .animate-fade-in {
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .animate-slide-up {
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Status Indicators */
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 8px;
    }

    .status-success {
        background: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
    }

    .status-warning {
        background: #f59e0b;
        box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
    }

    .status-error {
        background: #ef4444;
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
    }

    /* Error States */
    .input-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1) !important;
    }

    .text-error {
        color: #ef4444;
    }

    /* Success States */
    .input-success {
        border-color: #10b981 !important;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1) !important;
    }

    .text-success {
        color: #10b981;
    }

	/* Modal Mobile Styles */
    .modal-mobile {
        background: white;
        border-radius: 0;
        width: 100vw;
        height: 100vh;
        margin: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .dark .modal-mobile {
        background: #1f2937;
    }

    @media (min-width: 768px) {
        .modal-mobile {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
            border-radius: 24px;
            width: auto;
            height: auto;
            max-width: 600px;
            max-height: 90vh;
            margin: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .dark .modal-mobile {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.95) 100%);
        }
    }

    /* Header */
    .modal-header-mobile {
        padding: 20px 20px 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .dark .modal-header-mobile {
        border-color: #374151;
        background: #111827;
    }

    @media (min-width: 768px) {
        .modal-header-mobile {
            padding: 24px 32px;
            border-bottom: none;
            background: transparent;
            position: static;
        }
    }

    .close-btn-mobile {
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        background: #e5e7eb;
        color: #6b7280;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
    }

    .close-btn-mobile:hover {
        background: #d1d5db;
        color: #374151;
    }

    .dark .close-btn-mobile {
        background: #374151;
        color: #9ca3af;
    }

    .dark .close-btn-mobile:hover {
        background: #4b5563;
        color: #d1d5db;
    }

    /* Content */
    .modal-content-mobile {
        flex: 1;
        overflow-y: auto;
        padding: 0 20px 20px 20px;
        -webkit-overflow-scrolling: touch;
    }

    @media (min-width: 768px) {
        .modal-content-mobile {
            padding: 0 32px 32px 32px;
        }
    }

    /* Form */
    .form-mobile {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding-bottom: 20px;
    }

    .form-group-mobile {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-row-mobile {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }

    @media (min-width: 640px) {
        .form-row-mobile {
            grid-template-columns: 1fr 1fr;
        }
    }

    .label-mobile {
        font-size: 16px;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        margin-bottom: 4px;
    }

    .dark .label-mobile {
        color: #d1d5db;
    }

    .input-mobile {
        width: 100%;
        padding: 16px 18px;
        border: 2px solid #e5e7eb;
        border-radius: 14px;
        font-size: 16px;
        background: #ffffff;
        color: #111827;
        transition: all 0.3s ease;
        min-height: 54px;
    }

    .input-mobile:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        background: #ffffff;
    }

    .dark .input-mobile {
        background: #374151;
        color: #f3f4f6;
        border-color: #4b5563;
    }

    .dark .input-mobile:focus {
        background: #4b5563;
        border-color: #3b82f6;
    }

    /* Payment Section */
    .payment-header-mobile {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .payment-total-mobile {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        min-width: 100px;
        justify-content: center;
    }

    .payment-splits-mobile {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px;
    }

    .add-payment-btn-mobile {
        width: 100%;
        padding: 14px 20px;
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        background: #f8fafc;
        color: #3b82f6;
        font-weight: 600;
        font-size: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .add-payment-btn-mobile:hover {
        border-color: #3b82f6;
        background: #eff6ff;
        color: #1d4ed8;
    }

    .dark .add-payment-btn-mobile {
        border-color: #4b5563;
        background: #374151;
        color: #60a5fa;
    }

    .dark .add-payment-btn-mobile:hover {
        border-color: #60a5fa;
        background: #4b5563;
    }

    /* Submit Button */
    .form-actions-mobile {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 16px 0 0 0;
        margin: 20px -20px -20px -20px;
        padding: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .dark .form-actions-mobile {
        background: #1f2937;
        border-color: #374151;
    }

    @media (min-width: 768px) {
        .form-actions-mobile {
            position: static;
            background: transparent;
            padding: 0;
            margin: 0;
            border-top: none;
        }
    }

    .submit-btn-mobile {
        width: 100%;
        padding: 18px 24px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 56px;
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
    }

    .submit-btn-mobile:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);
    }

    .submit-btn-mobile:active {
        transform: translateY(0);
    }

    .submit-btn-mobile:disabled {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Payment Split Row Mobile */
    .payment-split-row-mobile {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .dark .payment-split-row-mobile {
        background: #374151;
        border-color: #4b5563;
    }

    .payment-split-controls-mobile {
        display: flex;
        gap: 8px;
        align-items: flex-end;
    }

    .payment-split-controls-mobile > * {
        flex: 1;
    }

    .payment-split-controls-mobile .btn-danger-mobile {
        flex: none;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .payment-split-controls-mobile .btn-danger-mobile:hover {
        background: #dc2626;
    }

    /* Responsive Improvements */
    @media (max-width: 480px) {
        .modal-content-mobile {
            padding: 0 16px 16px 16px;
        }
        
        .modal-header-mobile {
            padding: 16px;
        }
        
        .form-actions-mobile {
            margin: 16px -16px -16px -16px;
            padding: 16px;
        }
    }

    /* Accessibility & Touch Improvements */
    @media (hover: none) and (pointer: coarse) {
        .input-mobile {
            min-height: 48px;
            font-size: 16px;
        }
        
        .submit-btn-mobile {
            min-height: 50px;
        }
        
        .close-btn-mobile {
            width: 48px;
            height: 48px;
        }
    }

    /* Date Picker - Same Height as Other Buttons */
    .date-picker-container-mobile {
        position: relative;
        flex-shrink: 0;
    }

    .date-picker-btn-mobile {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border: none;
        border-radius: 16px;
        padding: 16px 20px;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
        position: relative;
        overflow: hidden;
        min-height: 56px;
        white-space: nowrap;
    }

    .date-picker-btn-mobile::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.6s ease;
    }

    .date-picker-btn-mobile:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 16px 48px rgba(59, 130, 246, 0.4);
    }

    .date-picker-btn-mobile:hover::before {
        left: 100%;
    }

    .date-picker-btn-mobile:active {
        transform: translateY(-2px) scale(1.02);
    }

    .dark .date-picker-btn-mobile {
        background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
    }

    .date-picker-icon-mobile {
        font-size: 16px;
    }

    .date-picker-text-mobile {
        font-size: 16px;
        font-weight: 700;
    }

    .date-picker-arrow-mobile {
        font-size: 12px;
        transition: transform 0.2s ease;
        opacity: 0.8;
    }

    .date-picker-btn-mobile.active .date-picker-arrow-mobile {
        transform: rotate(180deg);
    }

    /* Success state when date is selected */
    .date-picker-btn-mobile.has-date {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
    }

    .date-picker-btn-mobile.has-date:hover {
        box-shadow: 0 16px 48px rgba(59, 130, 246, 0.4);
    }

    /* When calendar is open */
    .date-picker-btn-mobile.active {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
    }

    .date-picker-btn-mobile.active:hover {
        box-shadow: 0 16px 48px rgba(139, 92, 246, 0.4);
    }

    /* Mobile optimizations to match other buttons exactly */
    @media (max-width: 768px) {
        .date-picker-btn-mobile {
            padding: 14px 16px;
            font-size: 15px;
            border-radius: 12px;
            min-height: 52px;
            gap: 6px;
        }
        
        .date-picker-icon-mobile {
            font-size: 14px;
        }
        
        .date-picker-text-mobile {
            font-size: 15px;
        }
        
        .date-picker-arrow-mobile {
            font-size: 11px;
        }
    }

    /* Desktop - maintain consistency */
    @media (min-width: 1024px) {
        .date-picker-container-mobile {
            width: auto;
            flex: 0 0 auto;
        }
    }
	.payment-badge-bank {
    background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    color: #3730a3;
}
.dark .payment-badge-bank {
    background: linear-gradient(135deg, #3730a3 0%, #4338ca 100%);
    color: #e0e7ff;
}
.comparison-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.comparison-row:last-child {
    border-bottom: none;
}

.comparison-icon {
    font-size: 12px;
    margin-left: 4px;
}

.comparison-text {
    font-size: 11px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 2px;
}

/* אנימציה לשינויים */
.change-animation {
    animation: changeHighlight 0.3s ease-in-out;
}

@keyframes changeHighlight {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
/* עיצוב לסכום החודשי בכותרת הקלנדר */
.flatpickr-calendar .flatpickr-months {
    position: relative;
}

.month-total {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
}

.month-amount {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    display: inline-block;
    min-width: 50px;
    text-align: center;
    letter-spacing: 0.025em;
}

.dark .month-amount {
    background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
    box-shadow: 0 2px 8px rgba(30, 64, 175, 0.4);
}

/* מצב רספונסיבי */
@media (max-width: 480px) {
    .month-total {
        left: 5px;
    }
    
    .month-amount {
        font-size: 10px;
        padding: 3px 6px;
        min-width: 45px;
    }
}

/* אנימציה לעדכון הסכום */
.month-amount {
    transition: all 0.3s ease;
}

.month-amount.updating {
    animation: monthAmountUpdate 0.4s ease-in-out;
}

@keyframes monthAmountUpdate {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    100% { transform: scale(1); }
}
/* תיקון עיצוב כפתורי הפקד במובייל */
@media (max-width: 640px) {
    /* שורת הכפתורים במובייל */
    .flex.gap-3:has(#addRideBtn) {
        display: grid;
        grid-template-columns: auto 1fr 1fr;
        gap: 8px;
        align-items: center;
    }
    
    /* כפתורי נסיעה והוצאה - אותו גודל */
    #addRideBtn,
    #addExpenseBtn {
        min-height: 52px !important;
        padding: 12px 16px !important;
        font-size: 15px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 6px !important;
        width: 100% !important;
    }
    
    /* תפריט הוצאות במובייל - צמוד לכפתור */
    #expenseTypeMenu {
        position: fixed !important;
        bottom: 140px !important;  /* צמוד יותר לכפתור */
        left: 16px !important;
        right: 16px !important;
        top: auto !important;
        transform: none !important;
        max-width: none !important;
        width: auto !important;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25) !important;
        border: 2px solid rgba(59, 130, 246, 0.3) !important;
        backdrop-filter: blur(8px) !important;
        background: rgba(255, 255, 255, 0.95) !important;
        z-index: 9999 !important;
    }
    
    /* רקע מטושטש במובייל */
    #expenseTypeMenu:not(.hidden)::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
        z-index: -1;
        animation: fadeInBackdrop 0.3s ease-out;
    }
    
    /* עיצוב מיוחד למצב חשוך */
    .dark #expenseTypeMenu {
        background: rgba(31, 41, 59, 0.95) !important;
        border-color: rgba(96, 165, 250, 0.3) !important;
    }
    
    /* אנימציה לתפריט במובייל */
    #expenseTypeMenu:not(.hidden) {
        animation: slideUpMobileClose 0.3s ease-out;
    }
    
    /* כפתור בחירת תאריך */
    .date-picker-btn-mobile {
        min-width: 90px !important;
        padding: 12px 14px !important;
        font-size: 14px !important;
    }
    
    .date-picker-text-mobile {
        font-size: 14px !important;
    }
    
    .date-picker-icon-mobile {
        font-size: 13px !important;
    }
}

/* backdrop overlay למובייל */
.expense-menu-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(8px);
    z-index: 9998;
    animation: fadeInBackdrop 0.3s ease-out;
}

/* אנימציות */
@keyframes slideUpMobileClose {
    from {
        transform: translateY(20px);
        opacity: 0;
        scale: 0.95;
    }
    to {
        transform: translateY(0);
        opacity: 1;
        scale: 1;
    }
}

@keyframes fadeInBackdrop {
    from {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        backdrop-filter: blur(8px);
    }
}

/* תיקון למסכי דסקטופ - צמוד יותר */
@media (min-width: 641px) {
    #expenseTypeMenu {
        min-width: 280px;
        max-width: 320px;
        margin-top: 4px !important; /* צמוד יותר בדסקטופ */
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15), 0 4px 16px rgba(0, 0, 0, 0.08) !important;
    }
    
    #addRideBtn,
    #addExpenseBtn {
        min-width: 140px;
        white-space: nowrap;
    }
}

/* תיקון כללי לכפתורים */
#addRideBtn,
#addExpenseBtn {
    flex-shrink: 0;
    text-overflow: ellipsis;
    overflow: hidden;
}

/* תיקון position relative לcontainer */
.relative:has(#addExpenseBtn) {
    position: relative;
}

/* עיצוב משופר לכפתורים בתפריט */
#expenseTypeMenu button {
    transition: all 0.2s ease;
    border-radius: 8px;
    margin: 4px;
    padding: 16px !important;
}

#expenseTypeMenu button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

#expenseTypeMenu button:active {
    transform: translateY(0);
}
.payment-type-card-clickable {
    cursor: pointer;
    transition: box-shadow 0.2s, transform 0.15s;
}
.payment-type-card-clickable:hover, .payment-type-card-clickable:active {
    box-shadow: 0 4px 20px rgba(59,130,246,0.15), 0 2px 8px rgba(59,130,246,0.09);
    transform: scale(1.04);
    border: 2px solid #3b82f6;
}
.payment-type-ride-row.clickable {
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
}
.payment-type-ride-row.clickable:hover {
  background: #eff6ff;
  box-shadow: 0 4px 16px rgba(59,130,246,0.08);
}

/* Work Days Buttons */
.workday-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 12px 8px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    background: #f9fafb;
    color: #6b7280;
    cursor:  pointer;
    transition: all 0.2s ease;
    font-size: 12px;
    font-weight:  600;
}

.dark .workday-btn {
    background: #374151;
    border-color: #4b5563;
    color: #9ca3af;
}

.workday-btn: hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.workday-btn.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-color: #10b981;
    color: white;
}

.workday-btn.active:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
}

.workday-btn i {
    font-size: 16px;
}

.workday-btn span {
    font-size: 11px;
}

/* Forecast Explanation */
.forecast-explanation {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 2px solid #3b82f6;
    border-radius: 16px;
    padding: 16px;
    margin-top:  16px;
}

.dark .forecast-explanation {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-color: #60a5fa;
}

.forecast-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom:  1px solid rgba(59, 130, 246, 0.2);
}

.forecast-stat: last-child {
    border-bottom: none;
}

.forecast-stat-label {
    font-size: 13px;
    color: #1e40af;
    display: flex;
    align-items: center;
    gap: 6px;
}

.dark .forecast-stat-label {
    color:  #dbeafe;
}

.forecast-stat-value {
    font-size: 14px;
    font-weight: 700;
    color: #1e40af;
}

.dark .forecast-stat-value {
    color: #bfdbfe;
}
</style>
</head>

<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 modal-backdrop">
        <div class="modal">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-primary-100 to-primary-200 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <i class="fas fa-car text-primary-600 text-3xl"></i>
                </div>
                <h2 id="authTitle" class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">התחבר למערכת</h2>
                <p id="authSubtitle" class="text-gray-500 dark:text-gray-400">הכנס את פרטי החשבון שלך</p>
            </div>
            
            <form id="authForm" class="space-y-6">
                <div class="space-y-2">
                    <label for="email" class="block text-sm font-semibold text-gray-700 dark:text-gray-300">אימייל</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                            <i class="fas fa-envelope text-gray-400"></i>
                        </div>
                        <input
                            id="email"
                            type="email"
                            required
                            placeholder="your@email.com"
                            class="input pr-12"
                        >
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label for="password" class="block text-sm font-semibold text-gray-700 dark:text-gray-300">סיסמה</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                            <i class="fas fa-lock text-gray-400"></i>
                        </div>
                        <input
                            id="password"
                            type="password"
                            required
                            placeholder="הקלד סיסמה"
                            class="input pr-12"
							autocomplete="current-password"
                        >
                    </div>
                </div>
                
                <button type="submit" id="authSubmit" class="w-full btn text-base py-4">
                    <i class="fas fa-sign-in-alt"></i>
                    <span id="authSubmitText">התחבר</span>
                </button>
            </form>
            
            <div class="mt-8 text-center">
                <p id="authToggleText" class="text-gray-600 dark:text-gray-400 text-sm">
                    אין לך משתמש?
                    <a href="#" id="toggleAuth" class="font-semibold text-primary-600 hover:text-primary-700 hover:underline transition">הירשם כאן</a>
                </p>
                <div class="mt-4">
                    <a href="#" id="forgotPasswordLink" class="text-sm text-primary-600 hover:underline transition">
                        שכחת סיסמה?
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 md:px-8 md:py-10 max-w-7xl">
        <!-- Header -->
        <header class="mb-10">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-8">
                <div class="flex items-center gap-6">
                    <div class="flex-shrink-0">
    <img 
        src="logo.png" 
        alt="לוגו יומן הדרייבר"
        class="w-14 h-14 md:w-16 md:h-16 object-contain"
    />
</div>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-black text-gray-800 dark:text-gray-100 mb-2">יומן הדרייבר</h1>
                        <p class="text-gray-500 dark:text-gray-400">לתעד את הנסיעות במקום אחד</p>
                        <div id="driver-level" class="flex items-center gap-3 mt-3"></div>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-3 w-full lg:w-auto">
				<!-- כפתור חדש לדרייבר חכם! -->
					
<a href="tasks-journal.html" target="_blank" class="btn bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800">
    <i class="fas fa-tasks"></i>
    יומן משימות
</a>
<a href="stations.html" class="btn bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover: to-indigo-800">
    <i class="fas fa-store"></i>
    מעקב תחנות
</a>
					
					
                    <a href="ratings.html" class="btn bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800">
                        <i class="fas fa-star"></i>
                        דירוג מערכת
                    </a>
                    
                    <a href="https://wa.me/972543336737?text=שלום,%20אני%20צריך%20עזרה%20במנהל%20נסיעות%20פרו" 
                       target="_blank" 
                       class="btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700">
                        <i class="fab fa-whatsapp"></i>
                        תמיכה טכנית
                    </a>
                    
                    <a href="https://wa.me/?text=ממליץ%20לך%20להירשם%20למנהל%20נסיעות%20-%20מערכת%20מטורפת%20לניהול%20נסיעות%20ותשלומים.%0A%0Ahttps://jewish-driver.netlify.app/" 
                       target="_blank" 
                       class="btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700">
                        <i class="fab fa-whatsapp"></i>
                        שתף והמלץ
                    </a>
                    
                   <button id="themeToggle" class="btn bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 clickable" title="מצב לילה/יום">
    <i class="fas fa-moon"></i>
    <span id="themeText">מצב לילה</span>
</button>
                    
                    <button id="logoutBtn" class="btn bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700">
                        <i class="fas fa-sign-out-alt"></i>
                        התנתק
                    </button>
                </div>
            </div>
            
<!-- Controls Row - גרסה מתוקנת -->
<div class="flex flex-col lg:flex-row gap-4 mt-8">
    
    <div class="flex gap-3">
        <div class="date-picker-container-mobile">
            <label for="datePicker" class="sr-only">בחר תאריך</label>
            <button 
                type="button" 
                id="datePicker" 
                class="date-picker-btn-mobile"
                aria-label="בחר תאריך"
            >
                <i class="fas fa-calendar-alt date-picker-icon-mobile"></i>
                <span id="selectedDateDisplay" class="date-picker-text-mobile">היום</span>
                <i class="fas fa-chevron-down date-picker-arrow-mobile"></i>
            </button>
            <input type="text" id="hiddenDatePicker" style="display: none;" />
        </div>
        
        <!-- הכפתורים המתוקנים -->
        <button id="addRideBtn" class="btn whitespace-nowrap min-w-0 flex-1 sm:flex-none">
            <i class="fas fa-plus"></i>
            <span class="hidden sm:inline">נסיעה חדשה</span>
            <span class="sm:hidden">נסיעה</span>
        </button>
        
        <div class="relative min-w-0 flex-1 sm:flex-none">
            <button 
                id="addExpenseBtn" 
                class="btn bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 whitespace-nowrap w-full"
                onclick="showExpenseTypeMenu()"
            >
                <i class="fas fa-receipt"></i>
                <span class="hidden sm:inline">הוצאה חדשה</span>
                <span class="sm:hidden">הוצאה</span>
                <i class="fas fa-chevron-down text-xs opacity-75 mr-1"></i>
            </button>
            
            <!-- תפריט מתוקן -->
            <div id="expenseTypeMenu" class="fixed sm:absolute left-4 right-4 sm:left-auto sm:right-0 top-auto sm:top-full mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-50 hidden transform -translate-y-full sm:translate-y-0">
                <button 
                    onclick="openAddExpenseModal(false)" 
                    class="w-full text-right px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors border-b border-gray-100 dark:border-gray-600 flex items-center gap-3"
                >
                    <i class="fas fa-receipt text-green-600 flex-shrink-0"></i>
                    <div class="text-right flex-1">
                        <div class="font-medium">הוצאה חד פעמית</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">הוצאה חד פעמית רגילה</div>
                    </div>
                </button>
                <button 
                    onclick="openAddExpenseModal(true)" 
                    class="w-full text-right px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center gap-3"
                >
                    <i class="fas fa-sync text-blue-600 flex-shrink-0"></i>
                    <div class="text-right flex-1">
                        <div class="font-medium">הוצאה חודשית קבועה</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">תחזור אוטומטית כל חודש</div>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>
        </header>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-10">
            <!-- Rides Summary Card -->
            <!-- עדכון כרטיסיית נסיעות בindex.html -->
<div class="card">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">נסיעות</h3>
        <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-xl">
            <i class="fas fa-car-side text-blue-600 dark:text-blue-300"></i>
        </div>
    </div>
    <div class="space-y-3">
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-500 dark:text-gray-400">היום</span>
            <span id="daily-rides-count" class="text-2xl font-bold text-gray-800 dark:text-gray-100">0</span>
        </div>
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-500 dark:text-gray-400">החודש</span>
            <span id="monthly-rides-count" class="text-2xl font-bold text-gray-800 dark:text-gray-100">0</span>
        </div>
        <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
            <div class="grid grid-cols-1 gap-2">
                <div class="flex items-center justify-between text-xs">
                    <span class="text-gray-500 dark:text-gray-400">מהיום הקודם</span>
                    <span id="daily-rides-change" class="font-medium">0%</span>
                </div>
                <div class="flex items-center justify-between text-xs">
                    <span class="text-gray-500 dark:text-gray-400">מהחודש הקודם</span>
                    <span id="monthly-rides-change" class="font-medium">0%</span>
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- Daily Income Card -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">הכנסה יומית</h3>
                    <div class="bg-green-100 dark:bg-green-900 p-3 rounded-xl">
                        <i class="fas fa-shekel-sign text-green-600 dark:text-green-300"></i>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400">ברוטו</span>
                        <span id="daily-income" class="text-xl font-bold text-purple-600">₪0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400">נטו</span>
                        <span id="daily-net-income-before-expenses" class="text-xl font-bold text-green-600">₪0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400">הוצאות</span>
                        <span id="daily-expenses-sum" class="text-xl font-bold text-red-600">₪0.00</span>
                    </div>
                    <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">נטו סופי</span>
                            <span id="daily-net-income-after-expenses" class="text-xl font-bold text-green-800 dark:text-green-200">₪0.00</span>
                        </div>
                    </div>
					<div class="pt-2 border-t border-gray-200 dark:border-gray-700">
    <div class="flex items-center gap-2 text-xs">
        <span id="daily-income-change" class="font-medium">0%</span>
        <span class="text-gray-500 dark:text-gray-400">מהיום הקודם</span>
    </div>
</div>
                </div>
            </div>

            <!-- Monthly Income Card -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">הכנסה חודשית</h3>
                    <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-xl">
                        <i class="fas fa-chart-line text-blue-600 dark:text-blue-300"></i>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400">ברוטו</span>
                        <span id="monthly-income" class="text-xl font-bold text-purple-600">₪0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400">נטו</span>
                        <span id="monthly-net-income-before-expenses" class="text-xl font-bold text-green-600">₪0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400">הוצאות</span>
                        <span id="monthly-expenses-sum" class="text-xl font-bold text-red-600">₪0.00</span>
                    </div>
                    <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">נטו סופי</span>
                            <span id="monthly-net-income-after-expenses" class="text-xl font-bold text-green-800 dark:text-green-200">₪0.00</span>
                        </div>
                    </div>
					<div class="pt-2 border-t border-gray-200 dark:border-gray-700">
    <div class="flex items-center gap-2 text-xs">
        <span id="monthly-income-change" class="font-medium">0%</span>
        <span class="text-gray-500 dark:text-gray-400">מהחודש הקודם</span>
    </div>
</div>
                </div>
            </div>

            <!-- Payment Types Card -->
<div class="card">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">סוגי תשלום</h3>
        <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-xl">
            <i class="fas fa-credit-card text-purple-600 dark:text-purple-300"></i>
        </div>
    </div>
    <div class="grid grid-cols-2 lg:grid-cols-3 gap-3">
        <div class="text-center p-3 bg-green-50 dark:bg-green-900/50 rounded-lg">
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">מזומן</div>
            <div class="font-bold text-green-700 dark:text-green-300">₪<span id="monthly-cash-net">0.00</span></div>
        </div>
        <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/50 rounded-lg">
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">ביט</div>
            <div class="font-bold text-blue-700 dark:text-blue-300">₪<span id="monthly-bit-net">0.00</span></div>
        </div>
        <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/50 rounded-lg">
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">פייבוקס</div>
            <div class="font-bold text-purple-700 dark:text-purple-300">₪<span id="monthly-paybox-net">0.00</span></div>
        </div>
        <div class="text-center p-3 bg-indigo-50 dark:bg-indigo-900/50 rounded-lg">
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">העברה בנקאית</div>
            <div class="font-bold text-indigo-700 dark:text-indigo-300">₪<span id="monthly-bank-net">0.00</span></div>
        </div>
        <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900/50 rounded-lg col-span-2 lg:col-span-1">
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">פתק</div>
            <div class="font-bold text-yellow-700 dark:text-yellow-300">₪<span id="monthly-note-net">0.00</span></div>
        </div>
    </div>
</div>

            <!-- Expenses Summary Card -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">הוצאות</h3>
                    <div class="bg-red-100 dark:bg-red-900 p-3 rounded-xl">
                        <i class="fas fa-receipt text-red-600 dark:text-red-300"></i>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400">היום</span>
                        <span id="daily-expenses-count" class="text-2xl font-bold text-gray-800 dark:text-gray-100">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400">החודש</span>
                        <span id="monthly-expenses-count" class="text-2xl font-bold text-gray-800 dark:text-gray-100">0</span>
                    </div>
                    <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">סה"כ כל הזמנים</span>
                            <span id="alltime-expenses-sum" class="text-lg font-bold text-red-700 dark:text-red-300">₪0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Time Profit Card -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">רווח כל הזמנים</h3>
                    <div class="bg-indigo-100 dark:bg-indigo-900 p-3 rounded-xl">
                        <i class="fas fa-infinity text-indigo-600 dark:text-indigo-300"></i>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400">נטו לפני הוצאות</span>
                        <span id="alltime-net-profit" class="text-xl font-bold text-blue-600">₪0.00</span>
                    </div>
                    <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">נטו אחרי הוצאות</span>
                            <span id="alltime-net-profit-after-expenses" class="text-xl font-bold text-purple-600">₪0.00</span>
                        </div>
                    </div>
                </div>
            </div>

<!-- Goals Card (UPGRADED) -->
<div id="goalDisplayCard" class="card hidden">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">היעד החודשי שלך</h3>
        <div class="bg-amber-100 dark:bg-amber-900 p-3 rounded-xl">
            <i class="fas fa-bullseye text-amber-600 dark:text-amber-300"></i>
        </div>
    </div>
    
    <div class="space-y-4">
        <!-- Progress Bar -->
        <div>
            <div class="flex justify-between items-center mb-2">
                <span class="font-medium text-gray-700 dark: text-gray-300">התקדמות</span>
                <span id="goalProgressPercentage" class="font-bold text-primary-600">0%</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                <div id="goalProgressBar" class="bg-gradient-to-r from-primary-500 to-primary-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-3">
            <div class="text-center bg-green-50 dark:bg-green-900/30 p-3 rounded-lg">
                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">הושלם</div>
                <div id="goalCompleted" class="text-lg font-bold text-green-600">₪0</div>
            </div>
            <div class="text-center bg-red-50 dark:bg-red-900/30 p-3 rounded-lg">
                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">נותר ליעד</div>
                <div id="goalRemaining" class="text-lg font-bold text-red-600">₪0</div>
            </div>
        </div>
        
        <!-- Forecast Section -->
        <div class="forecast-explanation">
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-bold text-blue-900 dark:text-blue-100">
                    <i class="fas fa-chart-line ml-1"></i>
                    תחזית סוף חודש
                </span>
                <span id="goalForecast" class="text-xl font-black text-blue-900 dark: text-blue-100">₪0</span>
            </div>
            
            <div id="forecastBreakdown" class="space-y-1">
                <!-- Will be populated by JS -->
            </div>
        </div>
        
        <!-- Work Days Summary -->
        <div class="flex items-center justify-center gap-2 text-xs text-gray-600 dark:text-gray-400">
            <i class="fas fa-calendar-check text-purple-500"></i>
            <span id="workDaysSummary">עובד 5 ימים בשבוע</span>
        </div>
        
        <button id="editGoalBtn" class="w-full text-center text-sm text-blue-600 hover:underline mt-2 py-2">
            <i class="fas fa-edit ml-1"></i>
            ערוך יעד
        </button>
    </div>
</div>

<!-- Set Goal Card (UPGRADED) -->
<div id="goalSetCard" class="card">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">הגדר יעד חודשי חכם</h3>
        <div class="bg-sky-100 dark:bg-sky-900 p-3 rounded-xl">
            <i class="fas fa-bullseye text-sky-600 dark:text-sky-300"></i>
        </div>
    </div>
    
    <!-- Goal Amount -->
<div class="mb-4">
    <label for="goalInput" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
        <i class="fas fa-shekel-sign text-blue-500 ml-2"></i>
        יעד הכנסה ברוטו חודשי
    </label>
    <input type="number" id="goalInput" placeholder="לדוגמה: 15000" class="input">
    <p class="text-xs text-gray-500 dark: text-gray-400 mt-1">
        <i class="fas fa-info-circle"></i>
        היעד מחושב על סמך הכנסה ברוטו (לפני עמלות והוצאות)
    </p>
</div>
    
    <!-- Work Days Selection -->
    <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
            <i class="fas fa-calendar-week text-purple-500 ml-2"></i>
            ימי עבודה בשבוע
        </label>
        <div class="grid grid-cols-4 gap-2">
            <button type="button" class="workday-btn active" data-day="0">
                <i class="fas fa-check-circle"></i>
                <span>ראשון</span>
            </button>
            <button type="button" class="workday-btn active" data-day="1">
                <i class="fas fa-check-circle"></i>
                <span>שני</span>
            </button>
            <button type="button" class="workday-btn active" data-day="2">
                <i class="fas fa-check-circle"></i>
                <span>שלישי</span>
            </button>
            <button type="button" class="workday-btn active" data-day="3">
                <i class="fas fa-check-circle"></i>
                <span>רביעי</span>
            </button>
            <button type="button" class="workday-btn active" data-day="4">
                <i class="fas fa-check-circle"></i>
                <span>חמישי</span>
            </button>
            <button type="button" class="workday-btn" data-day="5">
                <i class="fas fa-times-circle"></i>
                <span>שישי</span>
            </button>
            <button type="button" class="workday-btn" data-day="6">
                <i class="fas fa-times-circle"></i>
                <span>שבת</span>
            </button>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
            <i class="fas fa-info-circle"></i>
            לחץ על יום כדי לסמן/לבטל אותו כיום עבודה
        </p>
    </div>
    
    <button id="saveGoalBtn" class="btn w-full">
        <i class="fas fa-save"></i>
        שמור יעד חודשי
    </button>
</div>

        </div>

        <!-- Rides History Table -->
<div class="card mb-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-3">
            <i class="fas fa-history text-primary-600"></i>
            היסטוריית נסיעות
        </h2>
        <div class="flex flex-col sm:flex-row gap-3">
            <!-- Search Input -->
            <div class="relative">
                <input
                    type="text"
                    id="ridesSearch"
                    placeholder="חפש נסיעות..."
                    class="input w-full md:w-64 pr-12"
                >
                <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
				<div class="flex gap-2 mb-3">
  <label for="ridesRange" class="text-sm font-medium">טווח:</label>
  <select id="ridesRange" class="input text-sm w-32">
    <option value="day">יום נבחר</option>
    <option value="month">חודש נבחר</option>
    <option value="all">כל הזמנים</option>
  </select>
</div>
            <!-- Sort Controls -->
            <div class="flex gap-2">
                <select id="sortBy" class="input text-sm px-3 py-2">
                    <option value="date">מיון לפי תאריך</option>
                    <option value="price">מיון לפי מחיר</option>
                </select>
                <button id="sortOrder" class="btn-secondary px-3 py-2 text-sm transition-all hover:scale-105" title="שנה כיוון מיון">
                    <i class="fas fa-sort-amount-down"></i>
                    <span class="hidden sm:inline mr-1">חדש→ישן</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="table">
            <thead>
                <tr>
                    <th class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" id="dateHeader">
                        <div class="flex items-center justify-between">
                            <span>תאריך ושעה</span>
                            <i class="fas fa-sort text-gray-400 text-sm" id="dateSort"></i>
                        </div>
                    </th>
                    <th>הנסיעה</th>
                    <th>פלאפון לקוח</th>
                    <th class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" id="priceHeader">
                        <div class="flex items-center justify-between">
                            <span>מחיר</span>
                            <i class="fas fa-sort text-gray-400 text-sm" id="priceSort"></i>
                        </div>
                    </th>
                    <th>עמלה</th>
                    <th>רווח</th>
                    <th>תשלום</th>
                    <th class="text-center">פעולות</th>
                </tr>
            </thead>
            <tbody id="rides-table-body">
                <tr>
                    <td colspan="9" class="text-center p-8 text-gray-500 dark:text-gray-400">
                        <div class="loading-spinner"></div>
                        <p class="mt-4">טוען נסיעות...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
        <div id="ridesCount" class="text-sm text-gray-600 dark:text-gray-400">
            <span>מוצגות</span>
            <span class="font-medium">0</span>
            <span>נסיעות</span>
        </div>
        <div class="flex items-center gap-3">
            <button id="prevPage" class="btn-secondary px-4 py-2" disabled>
                <i class="fas fa-chevron-right"></i>
            </button>
            <span class="flex items-center gap-2 text-sm">
                <span id="currentPage">1</span>
                <span>/</span>
                <span id="totalPages">1</span>
            </span>
            <button id="nextPage" class="btn-secondary px-4 py-2" disabled>
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
    </div>
</div>

<!-- Expenses History Table -->
<div class="card mb-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">

        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-3">
            <i class="fas fa-receipt text-red-600"></i>
            היסטוריית הוצאות
        </h2>
        <div class="flex flex-col sm:flex-row gap-3">
            <div class="relative">
                <input
                    type="text"
                    id="expensesSearch"
                    placeholder="חפש הוצאות..."
                    class="input w-full md:w-64 pr-12"
                >
                <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
				<div class="flex gap-2 mb-3">
  <label for="ridesRange" class="text-sm font-medium">טווח:</label>
  <select id="expensesRange" class="input text-sm w-32">
    <option value="day">יום נבחר</option>
    <option value="month">חודש נבחר</option>
    <option value="all">כל הזמנים</option>
  </select>
</div>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="table">
            <thead>
                <tr>
                    <th>תאריך ושעה</th>
                    <th>סוג הוצאה</th>
                    <th>פירוט</th>
                    <th>סכום</th>
                    <th class="text-center">פעולות</th>
                </tr>
            </thead>
            <tbody id="expenses-table-body">
                <tr>
                    <td colspan="5" class="text-center p-8 text-gray-500 dark:text-gray-400">
                        <div class="loading-spinner"></div>
                        <p class="mt-4">טוען הוצאות...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
        <div id="expensesCount" class="text-sm text-gray-600 dark:text-gray-400">
            <span>מוצגות</span>
            <span class="font-medium">0</span>
            <span>הוצאות</span>
        </div>
    </div>
</div>

        <!-- Export Report Section -->
        <div class="card">
            <div class="flex items-center gap-3 mb-6">
                <i class="fas fa-file-export text-primary-600 text-2xl"></i>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">ייצוא דוח נסיעות</h2>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-1">
                    <label for="reportRange" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">טווח דוח:</label>
                    <select id="reportRange" class="input">
                        <option value="day">יום נבחר</option>
                        <option value="month">חודש נבחר</option>
                        <option value="all">כל הזמנים</option>
                    </select>
                </div>
                
                <div class="flex gap-3">
                    <button id="exportRidesBtn" class="btn">
                        <i class="fas fa-download"></i>
                        ייצא דוח
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Ride Modal - מותאם למובייל -->
<div id="rideModal" class="fixed inset-0 z-50 hidden modal-backdrop">
    <div class="modal-mobile">
        <!-- Header מותאם למובייל -->
        <div class="modal-header-mobile">
            <div class="flex items-center justify-between">
                <div>
                    <h3 id="modalTitle" class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-100">הוסף נסיעה חדשה</h3>
                    <p id="modalSubtitle" class="text-sm text-gray-500 dark:text-gray-400">מלא את פרטי הנסיעה</p>
                </div>
                <button id="closeModalBtn" class="close-btn-mobile">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>
        
        <!-- תוכן הטופס -->
        <div class="modal-content-mobile">
            <form id="rideForm" class="form-mobile" novalidate>
                <input type="hidden" id="rideId">

                <!-- תאריך ושעה -->
                <div class="form-group-mobile">
                    <label for="rideDateTime" class="label-mobile">
                        <i class="fas fa-calendar-alt text-primary-500 ml-2"></i>
                        תאריך ושעה
                    </label>
                    <input
                        type="text"
                        id="rideDateTime"
                        placeholder="בחר תאריך ושעה"
                        class="input-mobile"
                        readonly
                    />
                </div>

                <!-- מקור ויעד -->
                <div class="form-row-mobile">
                    <div class="form-group-mobile">
                        <label for="source" class="label-mobile">
                            <i class="fas fa-map-marker-alt text-green-500 ml-2"></i>
                            מקור
                        </label>
                        <input
                            type="text"
                            id="source"
                            required
                            placeholder="תל אביב"
                            class="input-mobile"
                        />
                    </div>
                    <div class="form-group-mobile">
                        <label for="destination" class="label-mobile">
                            <i class="fas fa-flag-checkered text-red-500 ml-2"></i>
                            יעד
                        </label>
                        <input
                            type="text"
                            id="destination"
                            required
                            placeholder="חיפה"
                            class="input-mobile"
                        />
                    </div>
                </div>

                <!-- מחיר ועמלה -->
                <div class="form-row-mobile">
                    <div class="form-group-mobile">
                        <label for="price" class="label-mobile">
                            <i class="fas fa-shekel-sign text-blue-500 ml-2"></i>
                            מחיר (₪)
                        </label>
                        <input
                            type="number"
                            step="0.01"
                            id="price"
                            required
                            placeholder="100"
                            class="input-mobile"
                            inputmode="decimal"
                        />
                    </div>
                    <div class="form-group-mobile relative">
    <label for="commission" class="label-mobile">
        <i class="fas fa-shekel-sign text-blue-500 ml-2"></i>
        עמלה (₪)
    </label>
    <div class="flex items-center gap-2">
        <input
            type="number"
            step="0.01"
            id="commission"
            required
            placeholder="10"
            class="input-mobile flex-1"
            inputmode="decimal"
        />
        <!-- כפתור חישוב עמלה -->
        <button type="button" id="calcCommissionBtn" class="ml-2 p-2 rounded-full bg-blue-100 hover:bg-blue-200 dark:bg-blue-800 dark:hover:bg-blue-700 text-blue-600 dark:text-blue-200 shadow focus:outline-none" title="חשב עמלה אוטומטית">
            <i class="fas fa-calculator"></i>
            <span class="sr-only">חשב עמלה</span>
        </button>
    </div>
</div>
                </div>

                <!-- טלפון לקוח -->
                <div class="form-group-mobile">
                    <label for="customerPhone" class="label-mobile">
                        <i class="fas fa-phone text-purple-500 ml-2"></i>
                        טלפון לקוח
                    </label>
                    <input
                        type="tel"
                        id="customerPhone"
                        placeholder="050-1234567"
                        class="input-mobile"
                        inputmode="tel"
                    />
                </div>
				<div class="form-group-mobile">
    <label for="rideStation" class="label-mobile">
        <i class="fas fa-store text-indigo-500 ml-2"></i>
        תחנה (אופציולי)
    </label>
    <select id="rideStation" class="input-mobile">
        <option value="">ללא תחנה</option>
        <!-- Options will be populated dynamically -->
    </select>
    <p class="text-xs text-gray-500 mt-1">
        <i class="fas fa-info-circle"></i>
        בחר תחנה כדי לעקוב אחרי חיובים
    </p>
</div>
<!-- אופציות תשלום -->
<div class="form-group-mobile">
    <div class="payment-header-mobile">
        <label class="label-mobile">
            <i class="fas fa-credit-card text-indigo-500 ml-2"></i>
            התקבל ב
        </label>
        <div id="paymentTotal" class="payment-total-mobile">
            <span class="text-xs">סה"כ:</span>
            <span class="font-bold">₪0.00</span>
        </div>
    </div>
    
    <div id="payment-splits" class="payment-splits-mobile"></div>
    
    <button
        type="button"
        id="addPaymentBtn"
        class="add-payment-btn-mobile"
    >
        <i class="fas fa-plus-circle text-lg"></i>
        <span>הוסף אמצעי תשלום</span>
    </button>
</div>
                <!-- כפתור שמירה -->
                <div class="form-actions-mobile">
                    <button type="submit" class="submit-btn-mobile">
                        <i class="fas fa-save text-lg"></i>
                        <span id="submitBtnText">שמור נסיעה</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Expense Modal -->
<!-- עדכון המודל הקיים -->
<div id="expenseModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
    <div class="modal">
        <div class="flex justify-between items-center mb-6">
            <h3 id="expenseModalTitle" class="text-2xl font-bold text-gray-800 dark:text-gray-100">הוסף הוצאה חדשה</h3>
            <button id="closeExpenseModalBtn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition clickable">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="expenseForm" class="space-y-6" novalidate>
		
            <input type="hidden" id="expenseId" value="">
            <input type="hidden" id="isRecurring" value="false">
			    <!-- סוג הוצאה: חד פעמית / חודשית -->
    <div>
      <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">סוג הוצאה</label>
      <div class="flex gap-6">
        <label class="flex items-center gap-2">
          <input type="radio" name="expenseKind" id="expenseKindOneTime" value="oneTime" checked>
          <span>חד פעמית</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="expenseKind" id="expenseKindRecurring" value="recurring">
          <span>חודשית קבועה</span>
        </label>
      </div>
    </div>
            
            <!-- אם זו הוצאה חודשית, הצג הודעה -->
            <div id="recurringNotice" class="hidden bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-600 text-blue-800 dark:text-blue-200 p-4 rounded-xl">
                <div class="flex items-center gap-3">
                    <i class="fas fa-sync text-blue-600"></i>
                    <div>
                        <p class="font-bold">הוצאה חודשית קבועה</p>
                        <p class="text-sm">ההוצאה תתווסף אוטומטית כל חודש באותו תאריך</p>
                    </div>
                </div>
            </div>
            
            <div>
                <label for="expenseDate" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                    <span id="dateLabel">תאריך</span>
                </label>
                <input
                    type="text"
                    id="expenseDate"
                    placeholder="בחר תאריך"
                    class="input"
                />
                <p id="recurringDateHelp" class="text-xs text-gray-500 dark:text-gray-400 mt-1 hidden">
                    בחר את התאריך הראשון - ההוצאה תחזור באותו תאריך בכל חודש
                </p>
            </div>
            
            <div>
    <label for="expenseType" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">סוג הוצאה</label>
    <select id="expenseType" class="input" required>
        <option value="">בחר סוג</option>
        <option value="דלק">דלק</option>
        <option value="ביטוח">ביטוח</option>
        <option value="מוסך">מוסך</option>
        <option value="הוצאה כללית">הוצאה כללית</option>
    </select>
</div>

<!-- Custom Category Field (הוצאה כללית) -->
<div id="customCategoryGroup" class="hidden">
    <label for="customCategory" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
        <i class="fas fa-tag text-purple-500 ml-2"></i>
        שם הקטגוריה
    </label>
    <input
        type="text"
        id="customCategory"
        placeholder="לדוגמה: תיקון רדיו, כביסה, אוכל..."
        class="input"
    />
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
        הזן שם קטגוריה מותאם אישית
    </p>
</div>
            
            <div>
                <label for="expenseAmount" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">סכום (₪)</label>
                <input
                    type="number"
                    step="0.01"
                    id="expenseAmount"
                    required
                    placeholder="0.00"
                    class="input"
                />
            </div>
            
            <div>
                <label for="expenseNote" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">פירוט</label>
                <input
                    type="text"
                    id="expenseNote"
                    placeholder="הערה (לא חובה)"
                    class="input"
                />
            </div>
            
            <button type="submit" id="expenseSubmitBtn" class="w-full btn bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-base py-4">
                <i class="fas fa-save"></i>
                <span id="expenseSubmitText">שמור הוצאה</span>
            </button>
        </form>
    </div>
</div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal max-w-sm text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 dark:bg-red-900 mb-6">
                <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-3">מחיקת נסיעה</h3>
            <p class="text-gray-500 dark:text-gray-400 mb-8">האם אתה בטוח שברצונך למחוק נסיעה זו? פעולה זו לא ניתנת לביטול.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteBtn" class="btn-secondary px-6 py-3">
                    ביטול
                </button>
                <button id="confirmDeleteBtn" class="btn bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 px-6 py-3">
                    <i class="fas fa-trash-alt"></i>
                    מחק
                </button>
            </div>
        </div>
    </div>

    <!-- Global Search Modal -->
    <div id="globalSearchModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden modal-backdrop">
        <div class="modal max-w-4xl max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-primary-700 dark:text-primary-300">
                    <i class="fas fa-search mr-3"></i>תוצאות חיפוש
                </h2>
                <button id="closeGlobalSearchModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition clickable">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="globalSearchResults" class="overflow-x-auto"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="rateToast" class="toast hidden">
        <span>
            אהבת את המערכת?
            <a href="ratings.html" id="toastGoToRatings" class="underline text-white font-bold hover:bg-white/20 px-2 py-1 rounded transition">דרג עכשיו</a>
        </span>
    </div>

	<!-- Payment Type Modal - מובייל -->
<div id="paymentTypeModal" class="fixed inset-0 z-50 hidden modal-backdrop">
  <div class="modal-mobile">
    <div class="modal-header-mobile flex items-center justify-between">
      <div>
        <h3 id="paymentTypeModalTitle" class="text-xl font-bold text-gray-800 dark:text-gray-100">נסיעות לפי סוג תשלום</h3>
        <p id="paymentTypeModalSubtitle" class="text-sm text-gray-500 dark:text-gray-400"></p>
      </div>
      <button id="closePaymentTypeModalBtn" class="close-btn-mobile"><i class="fas fa-times text-lg"></i></button>
    </div>
    <div class="modal-content-mobile" id="paymentTypeModalContent">
      <div class="text-center py-8 text-gray-500 dark:text-gray-400">
        <div class="loading-spinner mx-auto"></div>
        <div class="mt-4">טוען נסיעות...</div>
      </div>
    </div>
  </div>
</div>

<div id="chatbot-container"></div>

    <!-- Scripts -->
    <script>
        // Global variables - הגדרה ברמה הגלובלית
        let allRides = [];
        let filteredRides = [];
        let userId = null;
        let ridesCollectionRef = null;
        let rideDateTimePicker = null;
        let expenseDatePicker = null;
        let datePicker = null;
        let currentPage = 1;
        const ridesPerPage = 10;
        let datesWithRides = new Set();
        let app, db, auth;
		let isLoadingData = false;
		// === Cache System ===
const APP_CACHE = {
    rides: [],
    expenses: [],
    lastUpdate: null,
    cacheTimeout: 5 * 60 * 1000, // 5 דקות
    
    isValid() {
        return this.lastUpdate && (Date.now() - this.lastUpdate) < this.cacheTimeout;
    },
    
    set(rides, expenses) {
        this.rides = rides;
        this.expenses = expenses;
        this.lastUpdate = Date.now();
        
        try {
            localStorage.setItem('cachedRides', JSON.stringify(rides.slice(0, 100)));
            localStorage.setItem('cacheTimestamp', this.lastUpdate.toString());
        } catch (e) {
            console.warn('Cache save failed:', e);
        }
    },
    
    getFromLocalStorage() {
        try {
            const timestamp = parseInt(localStorage.getItem('cacheTimestamp') || '0');
            if (Date.now() - timestamp < this.cacheTimeout) {
                const cached = localStorage.getItem('cachedRides');
                return cached ? JSON.parse(cached) : null;
            }
        } catch (e) {
            console.warn('Cache read failed:', e);
        }
        return null;
    },
    
    clear() {
        this.rides = [];
        this.expenses = [];
        this.lastUpdate = null;
        localStorage.removeItem('cachedRides');
        localStorage.removeItem('cacheTimestamp');
    }
};
// === Instant Cache Loading ===
function loadInstantCache() {
    const cached = APP_CACHE.getFromLocalStorage();
    if (cached && cached.length > 0) {
        console.log('📦 Loading from cache:', cached.length, 'items');
        allRides = cached;
        
        const selectedDate = new Date();
        filterAndRenderRides(selectedDate);
        updateSummaryCards(allRides, selectedDate);
        updateDriverLevel(allRides, selectedDate);
        updateCalendarHighlights();
        
        showNotification('📦 נתונים נטענו מהמטמון - מרענן...', 'info');
        return true;
    }
    return false;
}
        const appId = "my-driver-b0d00";

        // Firebase modules - טעינה אסינכרונית
        let firebaseModules = {};
		// Sort state
		let currentSortBy = 'date'; // 'date' or 'price'
		let currentSortOrder = 'desc'; // 'asc' or 'desc'
        // Initialize Firebase
        async function initializeFirebase() {
            try {
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js");
                const authModule = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js");
                const firestoreModule = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");

                // Store modules globally
                firebaseModules = { ...authModule, ...firestoreModule };

                // Firebase Configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyAWOhJ4pSWnzMXOt8reavRWiLWtRS1ivzQ",
                    authDomain: "my-driver-b0d00.firebaseapp.com",
                    projectId: "my-driver-b0d00",
                    storageBucket: "my-driver-b0d00.firebasestorage.app",
                    messagingSenderId: "752217263540",
                    appId: "1:752217263540:web:2719a734580d03579eb6e1",
                    measurementId: "G-2TCCSTYFL1"
                };

                app = initializeApp(firebaseConfig);
                db = firebaseModules.getFirestore(app);
                auth = firebaseModules.getAuth(app);

                // Set persistence
                try {
                    await firebaseModules.setPersistence(auth, firebaseModules.browserLocalPersistence);
                } catch (err) {
                    console.error("Error setting persistence:", err);
                }

                return true;
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("שגיאה באתחול המערכת", 'error');
                return false;
            }
        }
		
		function getDayRange(d) {
  const start = new Date(d); start.setHours(0,0,0,0);
  const end = new Date(d);   end.setHours(23,59,59,999);
  return { start, end };
}
function getMonthRange(d) {
  const start = new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0);
  const end   = new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999);
  return { start, end };
}

// === שאילתות ממוקדות ל-Firestore ===
async function fetchRidesInRange(userId, start, end, limitN=500, cursor=null) {
  const col = firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/rides`);
  let q = firebaseModules.query(
    col,
    firebaseModules.where('rideDate', '>=', firebaseModules.Timestamp.fromDate(start)),
    firebaseModules.where('rideDate', '<=', firebaseModules.Timestamp.fromDate(end)),
    firebaseModules.orderBy('rideDate', 'desc'),
    firebaseModules.limit(limitN)
  );
  if (cursor) q = firebaseModules.query(q, firebaseModules.startAfter(cursor));
  const snap = await firebaseModules.getDocs(q);
  return {
    items: snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'ride' })),
    nextCursor: snap.docs.length ? snap.docs[snap.docs.length-1] : null
  };
}

async function fetchExpensesInRange(userId, start, end, limitN=500, cursor=null) {
  const col = firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/expenses`);
  let q = firebaseModules.query(
    col,
    firebaseModules.where('expenseDate', '>=', firebaseModules.Timestamp.fromDate(start)),
    firebaseModules.where('expenseDate', '<=', firebaseModules.Timestamp.fromDate(end)),
    firebaseModules.orderBy('expenseDate', 'desc'),
    firebaseModules.limit(limitN)
  );
  if (cursor) q = firebaseModules.query(q, firebaseModules.startAfter(cursor));
  const snap = await firebaseModules.getDocs(q);
  return {
    items: snap.docs.map(d => ({
      id: d.id, ...d.data(),
      type: 'expense',
      price: -Math.abs(d.data().amount || 0),
      commission: 0,
      source: d.data().type,
      destination: d.data().note || '',
      rideDate: d.data().expenseDate,
      customerPhone: '',
      payment: []
    })),
    nextCursor: snap.docs.length ? snap.docs[snap.docs.length-1] : null
  };
}

        function showNotification(message, type = 'success') {
    const toast = document.createElement('div');
    
    let bgClass = 'bg-gradient-to-r from-green-500 to-green-600';
    if (type === 'error') bgClass = 'bg-gradient-to-r from-red-500 to-red-600';
    if (type === 'warning') bgClass = 'bg-gradient-to-r from-yellow-500 to-yellow-600';
    if (type === 'info') bgClass = 'bg-gradient-to-r from-blue-500 to-blue-600';
    
    toast.className = `toast ${bgClass}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

        // Error handling wrapper
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            showNotification(`שגיאה ב${context}: ${error.message}`, 'error');
        }

        // Payment row management - פונקציות גלובליות
        function addPaymentRow(payment = { method: "ביט", amount: "", note: "" }) {
            const container = document.getElementById("payment-splits");
            if (!container) return;
            
            const row = document.createElement("div");
            row.className = "payment-split-row-mobile";
            
           const methodOptions = [
            { value: "ביט", icon: "fa-mobile-alt", color: "text-blue-500" },
            { value: "פייבוקס", icon: "fa-credit-card", color: "text-purple-500" },
            { value: "מזומן", icon: "fa-money-bill-wave", color: "text-green-500" },
            { value: "העברה בנקאית", icon: "fa-university", color: "text-indigo-500" },
            { value: "פתק", icon: "fa-sticky-note", color: "text-yellow-500" }
        ];

            row.innerHTML = `
                <div class="payment-split-controls-mobile">
                    <div class="form-group-mobile">
                        <label class="text-sm font-medium text-gray-600 dark:text-gray-400">אמצעי תשלום</label>
                        <select class="payment-method input-mobile">
                            ${methodOptions.map(opt => `
                                <option value="${opt.value}" ${payment.method === opt.value ? "selected" : ""}>
                                    ${opt.value}
                                </option>
                            `).join("")}
                        </select>
                    </div>
                    <div class="form-group-mobile">
                        <label class="text-sm font-medium text-gray-600 dark:text-gray-400">סכום (₪)</label>
                        <input
                            type="number"
                            step="0.01"
                            placeholder="0.00"
                            required
                            class="payment-amount input-mobile"
                            value="${payment.amount || ""}"
                            inputmode="decimal"
                        />
                    </div>
                    <button
                        type="button"
                        class="btn-danger-mobile"
                        title="הסר תשלום"
                        onclick="this.closest('.payment-split-row-mobile').remove(); updatePaymentTotal()"
                    >
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="form-group-mobile ${payment.method === "פתק" ? "" : "hidden"}">
                    <label class="text-sm font-medium text-gray-600 dark:text-gray-400">פירוט הפתק</label>
                    <input
                        type="text"
                        placeholder="פירוט נוסף..."
                        class="payment-note input-mobile"
                        value="${payment.note || ""}"
                        ${payment.method === "פתק" ? "required" : ""}
                    />
                </div>
            `;

            const methodSelect = row.querySelector(".payment-method");
            const noteGroup = row.querySelector(".form-group-mobile:last-child");
            const noteInput = row.querySelector(".payment-note");
            const amountInput = row.querySelector(".payment-amount");

            methodSelect.addEventListener("change", e => {
                if (e.target.value === "פתק") {
                    noteGroup.classList.remove("hidden");
                    noteInput.required = true;
                } else {
                    noteGroup.classList.add("hidden");
                    noteInput.required = false;
                }
                updatePaymentTotal();
            });

            amountInput.addEventListener("input", updatePaymentTotal);
            container.appendChild(row);
            updatePaymentTotal();
        }

        function updatePaymentTotal() {
            let total = 0;
            document.querySelectorAll(".payment-amount").forEach(input => {
                const amount = parseFloat(input.value) || 0;
                total += amount;
            });

            const price = parseFloat(document.getElementById("price")?.value) || 0;
            const totalElement = document.getElementById("paymentTotal");
            if (totalElement) {
                totalElement.textContent = `סה"כ: ₪${total.toFixed(2)}`;

                // Visual feedback for payment validation
                totalElement.classList.remove("text-red-600", "text-green-600");
                if (Math.abs(total - price) <= 0.01) {
                    totalElement.classList.add("text-green-600");
                } else if (price > 0) {
                    totalElement.classList.add("text-red-600");
                }
            }
        }

        // Theme management
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            const themeIcon = document.getElementById('themeToggle');
            
            if (themeIcon) {
                themeIcon.innerHTML = isDark ? 
                    '<i class="fas fa-sun"></i><span id="themeText">מצב יום</span>' : 
                    '<i class="fas fa-moon"></i><span id="themeText">מצב לילה</span>';
            }
            
            showNotification(`מצב ${isDark ? 'לילה' : 'יום'} הופעל`);
        }

        // Initialize theme
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
                const themeIcon = document.getElementById('themeToggle');
                if (themeIcon) {
                    themeIcon.innerHTML = '<i class="fas fa-sun"></i><span id="themeText">מצב יום</span>';
                }
            } else {
                const themeIcon = document.getElementById('themeToggle');
                if (themeIcon) {
                    themeIcon.innerHTML = '<i class="fas fa-moon"></i><span id="themeText">מצב לילה</span>';
                }
            }
        }

        function setupDatePickers() {
            if (typeof flatpickr === 'undefined') {
                console.error('Flatpickr not loaded');
                return;
            }

            const hiddenDatePickerElement = document.getElementById("hiddenDatePicker");
            const datePickerBtn = document.getElementById("datePicker");
            const selectedDateDisplay = document.getElementById("selectedDateDisplay");
            
            if (hiddenDatePickerElement && datePickerBtn) {
                datePicker = flatpickr(hiddenDatePickerElement, {
                    defaultDate: "today",
                    dateFormat: "d/m/Y",
                    locale: flatpickr.l10ns.he || "he",
                    disableMobile: true,
                    onChange: function(selectedDates) {
                        const selectedDate = selectedDates[0] || new Date();
                        
                        const today = new Date();
                        let displayText;
                        
                        if (selectedDate.toDateString() === today.toDateString()) {
                            displayText = "היום";
                        } else {
                            const tomorrow = new Date(today);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            
                            if (selectedDate.toDateString() === tomorrow.toDateString()) {
                                displayText = "מחר";
                            } else {
                                const yesterday = new Date(today);
                                yesterday.setDate(yesterday.getDate() - 1);
                                
                                if (selectedDate.toDateString() === yesterday.toDateString()) {
                                    displayText = "אתמול";
                                } else {
                                    displayText = selectedDate.toLocaleDateString('he-IL', {
                                        day: 'numeric',
                                        month: 'short'
                                    });
                                }
                            }
                        }
                        
                        if (selectedDateDisplay) {
                            selectedDateDisplay.textContent = displayText;
                            datePickerBtn.classList.add('has-date');
                        }
                        
                        filterAndRenderRides(selectedDate);
                        filterAndRenderExpenses(selectedDate);
                        updateSummaryCards(allRides, selectedDate);
                        updateDriverLevel(allRides, selectedDate);
                    },
                    onOpen: function() {
                        if (datePickerBtn) {
                            datePickerBtn.classList.add('active');
                        }
                    },
                    onClose: function() {
                        if (datePickerBtn) {
                            datePickerBtn.classList.remove('active');
                        }
                    },
                    onMonthChange: function(selectedDates, dateStr, instance) {
                        updateMonthHeaderWithTotal(instance);
                    },
                    onYearChange: function(selectedDates, dateStr, instance) {
                        updateMonthHeaderWithTotal(instance);
                    },
                    onDayCreate: function(dObj, dStr, fp, dayElem) {
                        const date = dayElem.dateObj;
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        const grossByDate = getGrossByDate();
                        const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        
                        if (date > today) {
                            dayElem.classList.add("day-future");
                        } else if (grossByDate[dayKey] > 0) {
                            dayElem.classList.add("day-with-rides");
                        } else {
                            dayElem.classList.add("day-without-rides");
                        }

                        let amountDiv = dayElem.querySelector('.calendar-amount');
                        if (amountDiv) amountDiv.remove();

                        const sum = date > today ? 0 : (grossByDate[dayKey] || 0);
                        amountDiv = document.createElement('div');
                        amountDiv.className = "calendar-amount";
                        amountDiv.textContent = `₪${sum.toFixed(0)}`;
                        dayElem.appendChild(amountDiv);
                    },
                    onReady: function(selectedDates, dateStr, instance) {
                        updateMonthHeaderWithTotal(instance);
                    }
                });

                datePickerBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (datePicker) {
                        datePicker.open();
                    }
                });

                if (selectedDateDisplay) {
                    selectedDateDisplay.textContent = "היום";
                    datePickerBtn.classList.add('has-date');
                }
            }

            const rideDateTimeElement = document.getElementById("rideDateTime");
            if (rideDateTimeElement) {
                rideDateTimePicker = flatpickr(rideDateTimeElement, {
                    enableTime: true,
                    time_24hr: true,
                    dateFormat: "Y-m-d H:i",
                    altInput: true,
                    altFormat: "d/m/Y H:i",
                    locale: flatpickr.l10ns.he || "he",
                    defaultDate: new Date()
                });
            }

            const expenseDateElement = document.getElementById("expenseDate");
            if (expenseDateElement) {
                expenseDatePicker = flatpickr(expenseDateElement, {
                    dateFormat: "Y-m-d",
                    altInput: true,
                    altFormat: "d/m/Y",
                    locale: flatpickr.l10ns.he || "he",
                    defaultDate: new Date()
                });
            }
        }
        
        function showExpenseTypeMenu() {
            const menu = document.getElementById("expenseTypeMenu");
            const btn = document.getElementById("addExpenseBtn");
            
            if (!menu || !btn) return;
            
            const isHidden = menu.classList.contains("hidden");
            
            if (isHidden) {
                menu.classList.remove("hidden");
                
                if (window.innerWidth <= 640) {
                    const backdrop = document.createElement('div');
                    backdrop.className = 'expense-menu-backdrop';
                    backdrop.id = 'expenseMenuBackdrop';
                    document.body.appendChild(backdrop);
                    document.body.style.overflow = 'hidden';
                    backdrop.addEventListener('click', closeExpenseMenu);
                }
                
            } else {
                closeExpenseMenu();
            }
            
            if (window.innerWidth > 640) {
                setTimeout(() => {
                    document.addEventListener("click", function closeMenu(e) {
                        if (!e.target.closest("#addExpenseBtn") && !e.target.closest("#expenseTypeMenu")) {
                            closeExpenseMenu();
                            document.removeEventListener("click", closeMenu);
                        }
                    });
                }, 10);
            }
        }

        function closeExpenseMenu() {
            const menu = document.getElementById("expenseTypeMenu");
            const backdrop = document.getElementById("expenseMenuBackdrop");
            
            if (menu) {
                menu.classList.add("hidden");
            }
            
            if (backdrop) {
                backdrop.remove();
            }
            
            document.body.style.overflow = '';
        }

        function openAddExpenseModal(isRecurring = false) {
            closeExpenseMenu();

            const expenseForm = document.getElementById("expenseForm");
            const modalTitle = document.getElementById("expenseModalTitle");
            const recurringNotice = document.getElementById("recurringNotice");
            const dateLabel = document.getElementById("dateLabel");
            const recurringDateHelp = document.getElementById("recurringDateHelp");
            const submitText = document.getElementById("expenseSubmitText");
            const isRecurringInput = document.getElementById("isRecurring");
            
            if (expenseForm) expenseForm.reset();
            document.getElementById("expenseId").value = "";
            
            if (isRecurring) {
                modalTitle.textContent = "הוסף הוצאה חודשית קבועה";
                recurringNotice.classList.remove("hidden");
                dateLabel.textContent = "תאריך החזרה הראשון";
                recurringDateHelp.classList.remove("hidden");
                submitText.textContent = "צור הוצאה חודשית";
                isRecurringInput.value = "true";
            } else {
                modalTitle.textContent = "הוסף הוצאה חדשה";
                recurringNotice.classList.add("hidden");
                dateLabel.textContent = "תאריך";
                recurringDateHelp.classList.add("hidden");
                submitText.textContent = "שמור הוצאה";
                isRecurringInput.value = "false";
            }
            
            if (expenseDatePicker) expenseDatePicker.setDate(new Date());
            
            const expenseModal = document.getElementById("expenseModal");
            if (expenseModal) {
                expenseModal.classList.remove("hidden");
                expenseModal.classList.add("flex");
            }
            
            const menu = document.getElementById("expenseTypeMenu");
            if (menu) {
                menu.classList.add("hidden");
                document.body.style.overflow = '';
            }
            
            setTimeout(() => {
                const expenseTypeInput = document.getElementById("expenseType");
                if (expenseTypeInput) expenseTypeInput.focus();
            }, 100);
        }

        async function processRecurringExpenses() {
            if (!userId || !firebaseModules) return false;
            
            try {
                const recurringExpensesSnapshot = await firebaseModules.getDocs(
                    firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/recurringExpenses`)
                );
                
                const now = new Date();
                const batch = firebaseModules.writeBatch(db);
                let hasNewExpenses = false;
                
                for (const docSnap of recurringExpensesSnapshot.docs) {
                    const recurringExpense = docSnap.data();
                    const startDate = recurringExpense.startDate.toDate();
                    const lastProcessed = recurringExpense.lastProcessed ? 
                        recurringExpense.lastProcessed.toDate() : 
                        new Date(startDate.getTime() - 24 * 60 * 60 * 1000);
                    
                    const expensesToCreate = [];
                    let currentDate = new Date(lastProcessed);
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    currentDate.setDate(startDate.getDate());
                    
                    while (currentDate <= now) {
                        expensesToCreate.push(new Date(currentDate));
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                    
                    for (const expenseDate of expensesToCreate) {
                        const newExpenseRef = firebaseModules.doc(
                            firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/expenses`)
                        );
                        
                        batch.set(newExpenseRef, {
                            type: recurringExpense.type,
                            amount: recurringExpense.amount,
                            note: `${recurringExpense.note} (הוצאה חודשית)`,
                            expenseDate: firebaseModules.Timestamp.fromDate(expenseDate),
                            isFromRecurring: true,
                            recurringId: docSnap.id,
                            createdAt: firebaseModules.serverTimestamp()
                        });
                        
                        hasNewExpenses = true;
                    }
                    
                    if (expensesToCreate.length > 0) {
                        batch.update(docSnap.ref, {
                            lastProcessed: firebaseModules.Timestamp.fromDate(expensesToCreate[expensesToCreate.length - 1])
                        });
                    }
                }
                
                if (hasNewExpenses) {
                    await batch.commit();
                    showNotification("הוצאות חודשיות חדשות נוצרו!");
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error("Error processing recurring expenses:", error);
                return false;
            }
        }

       function updateMonthHeaderWithTotal(flatpickrInstance) {
    if (!flatpickrInstance || !allRides) return;
    const currentMonth = flatpickrInstance.currentMonth;
    const currentYear = flatpickrInstance.currentYear;
    const monthlyGross = calculateMonthlyGrossByYearMonth(currentYear, currentMonth);
    const formattedAmount = formatCurrency(monthlyGross);

    const monthElement = flatpickrInstance.monthNav;
    if (!monthElement) return;

    const existingAmount = monthElement.querySelector('.month-total');
    if (existingAmount) existingAmount.remove();

    const monthTotalElement = document.createElement('span');
    monthTotalElement.className = 'month-total';
    monthTotalElement.innerHTML = `<span class="month-amount">${formattedAmount}</span>`;

    monthElement.appendChild(monthTotalElement);
}

        // === תיקון calculateMonthlyGross ===
function calculateMonthlyGrossByYearMonth(year, month) {
    try {
        const rides = allRides.filter(ride => {
            if (!ride.rideDate || ride.type === 'expense') return false;
            const rideDate = ride.rideDate instanceof Date
                ? ride.rideDate
                : ride.rideDate.toDate
                    ? ride.rideDate.toDate()
                    : ride.rideDate.seconds
                        ? new Date(ride.rideDate.seconds * 1000)
                        : new Date(ride.rideDate);
            if (isNaN(rideDate.getTime())) return false;
            return rideDate.getFullYear() === year && rideDate.getMonth() === month;
        });
        return rides.reduce((sum, ride) => sum + (parseFloat(ride.price) || 0), 0);
    } catch (error) {
        console.error('Error in calculateMonthlyGrossByYearMonth:', error);
        return 0;
    }
}


        function formatCurrency(amount) {
            if (amount >= 1000000) {
                return `₪${(amount / 1000000).toFixed(1)}M`;
            } else if (amount >= 1000) {
                return `₪${(amount / 1000).toFixed(1)}K`;
            } else {
                return `₪${amount.toFixed(0)}`;
            }
        }

        function getGrossByDate() {
    const grossByDate = {};
    
    if (!allRides || !Array.isArray(allRides)) return grossByDate;
    
    allRides.forEach(ride => {
        if (! ride.rideDate || ride.type === 'expense') return;
        
        try {
            // המר Timestamp ל-Date
            let date;
            
            if (ride.rideDate.toDate && typeof ride.rideDate.toDate === 'function') {
                date = ride.rideDate.toDate();
            } else if (ride.rideDate.seconds) {
                date = new Date(ride.rideDate.seconds * 1000);
            } else if (ride.rideDate instanceof Date) {
                date = ride.rideDate;
            } else {
                date = new Date(ride.rideDate);
            }
            
            // וודא שהתאריך תקין
            if (isNaN(date.getTime())) return;
            
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            
            if (!grossByDate[key]) grossByDate[key] = 0;
            grossByDate[key] += parseFloat(ride.price) || 0;
        } catch (error) {
            console. error('Error processing ride date in getGrossByDate:', error, ride);
        }
    });
    
    return grossByDate;
}

 async function fetchAllRidesAndExpenses() {
    if (!userId || !db || !firebaseModules) return [];

    try {
        // ✅ Parallel loading for better performance
        const [ridesSnapshot, expensesSnapshot] = await Promise.all([
            firebaseModules.getDocs(firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/rides`)),
            firebaseModules.getDocs(firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/expenses`))
        ]);
        
        const rides = ridesSnapshot.docs.map(doc => ({
            ...doc.data(),
            id: doc.id,
            type: 'ride',
        }));

        const expenses = expensesSnapshot.docs.map(doc => ({
            ...doc.data(),
            id: doc.id,
            type: 'expense',
            price: -Math.abs(doc.data().amount),
            commission: 0,
            source: doc.data().type,
            destination: doc.data().note || '',
            rideDate: doc.data().expenseDate,
            customerPhone: '',
            payment: [],
        }));

        return [...rides, ...expenses];
    } catch (error) {
        handleError(error, "טעינת נתונים");
        return [];
    }
}

async function initializeAppData(showSuccess = false) {
    if (!userId || !firebaseModules) return;
	
	 isLoadingData = true; // 🔒 נעילה

    const startTime = performance.now();
    
    // 🚀 שלב 1: טען מהמטמון מיד
    const hasCache = loadInstantCache();
    
    try {
        // ✅ שלב 2: עכשיו טען מ-Firebase (ברקע)
        const hasNewRecurringExpenses = await processRecurringExpenses();
        
        ridesCollectionRef = firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/rides`);
        
        // 🔥 כאן זה נשאר כמו שהיה - טוען הכל
        allRides = await fetchAllRidesAndExpenses();
        
        // שמור במטמון
        APP_CACHE.set(allRides, []);
        
        updateCalendarHighlights();
        
        const selectedDate = datePicker?.selectedDates[0] || new Date();
        filterAndRenderRides(selectedDate);
        filterAndRenderExpenses(selectedDate);
        updateSummaryCards(allRides, selectedDate);
        updateDriverLevel(allRides, selectedDate);

        if (datePicker) {
            updateMonthHeaderWithTotal(datePicker);
        }

        const loadTime = Math.round(performance.now() - startTime);
        console.log(`✅ Data loaded in ${loadTime}ms`);

        if (!hasCache) {
    showNotification('✅ המערכת עלתה בהצלחה!');
}
		
		isLoadingData = false; // 🔓 שחרור
        
    } catch (error) {
        handleError(error, "אתחול האפליקציה");
    }
}

        function updateCalendarHighlights() {
    datesWithRides.clear();
    allRides.forEach(ride => {
        if (ride.rideDate && ride.type !== 'expense') {
            const date = ride.rideDate.toDate
                ? ride.rideDate.toDate()
                : new Date(ride.rideDate.seconds ? ride.rideDate.seconds * 1000 : ride.rideDate);
            const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            datesWithRides.add(formattedDate);
        }
    });

    // הגנות על redraw
    if (datePicker && typeof datePicker.redraw === 'function') {
        datePicker.redraw();
        setTimeout(() => updateMonthHeaderWithTotal(datePicker), 100);
    }
}


        function renderRides() {
            const tbody = document.getElementById("rides-table-body");
            if (!tbody) return;

            const startIdx = (currentPage - 1) * ridesPerPage;
            const paginatedRides = filteredRides.slice(startIdx, startIdx + ridesPerPage);

            if (paginatedRides.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center p-8 text-gray-500 dark:text-gray-400">
                            <i class="far fa-folder-open text-4xl mb-4"></i>
                            <p>לא נמצאו נסיעות ביום זה</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = paginatedRides.map(item => {
                if (!item.rideDate) return "";

                const timestamp = item.rideDate.toDate ? 
                    item.rideDate.toDate() : 
                    new Date(item.rideDate.seconds ? item.rideDate.seconds * 1000 : item.rideDate);
                
                const datetime = timestamp.toLocaleString("he-IL", {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                if (item.type === "expense") {
                    return ``; // Expenses are rendered in their own table now
                }

                const netProfit = (item.price - item.commission).toFixed(2);
                const paymentBadges = (item.payment || []).map(p => {
                    let badgeClass = "payment-badge-bit";
                    if (p.method === "מזומן") badgeClass = "payment-badge-cash";
                    if (p.method === "פייבוקס") badgeClass = "payment-badge-paybox";
                    if (p.method === "פתק") badgeClass = "payment-badge-note";
					if (p.method === "העברה בנקאית") badgeClass = "payment-badge-bank";

                    return `
                        <div class="flex items-center gap-2 mb-1 last:mb-0">
                            <span class="${badgeClass} payment-badge">${p.method}</span>
                            <span class="text-xs font-medium text-gray-700 dark:text-gray-300">₪${p.amount.toFixed(2)}</span>
                            ${p.note ? `<span class="text-xs text-gray-500 dark:text-gray-400 truncate max-w-xs" title="${p.note}">${p.note}</span>` : ''}
                        </div>
                    `;
                }).join("");

                return `
                    <tr class="animate-fade-in hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all">
                        <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-gray-100 font-medium">${datetime}</td>
                        <td class="px-6 py-4 text-gray-900 dark:text-gray-100">
                            <div class="flex flex-col items-end">
                                <span class="font-semibold">${item.source}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
                                    <i class="fas fa-arrow-left"></i>
                                    ${item.destination}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-gray-100">${item.customerPhone || '—'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-blue-600 dark:text-blue-400 font-semibold">₪${item.price.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-red-500 dark:text-red-400 font-semibold">₪${item.commission.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-green-600 dark:text-green-400 font-bold">₪${netProfit}</td>
                        <td class="px-6 py-4 max-w-xs text-gray-900 dark:text-gray-100">${paymentBadges}</td>
                            <div class="flex flex-col items-center gap-1">
                                <div>
                                </div>
                                ${item.paymentStatusNote ? `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${item.paymentStatusNote}</div>` : ""}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center whitespace-nowrap">
                            <div class="flex items-center justify-center gap-2">
                                <button data-id="${item.id}" class="edit-btn text-primary-600 hover:text-primary-800 dark:hover:text-primary-400 p-2 transition clickable" title="ערוך"><i class="fas fa-edit"></i></button>
                                <button data-id="${item.id}" class="delete-btn text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-600 p-2 transition clickable" title="מחק"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join("");

            const ridesCountElement = document.getElementById("ridesCount");
            if (ridesCountElement) {
                ridesCountElement.innerHTML = `
                    <span>מוצגות</span>
                    <span class="font-medium">${startIdx + 1}-${Math.min(startIdx + ridesPerPage, filteredRides.length)}</span>
                    <span>מתוך</span>
                    <span class="font-medium">${filteredRides.length}</span>
                    <span>רשומות</span>
                `;
            }

            attachTableEventListeners();
        }
		
		let filteredExpenses = [];

        function filterAndRenderExpenses(selectedDate = new Date()) {
            const searchTerm = document.getElementById("expensesSearch")?.value.toLowerCase() || "";
            const range = document.getElementById("expensesRange")?.value || "day";

            filteredExpenses = allRides.filter(exp => {
                if (exp.type !== "expense" || !exp.rideDate) return false;
                const expDate = exp.rideDate.toDate ? exp.rideDate.toDate() : new Date(exp.rideDate?.seconds ? exp.rideDate.seconds * 1000 : exp.rideDate);

                let inRange = false;
                if (range === "day") {
                    inRange = expDate.toDateString() === selectedDate.toDateString();
                } else if (range === "month") {
                    inRange = expDate.getMonth() === selectedDate.getMonth() &&
                              expDate.getFullYear() === selectedDate.getFullYear();
                } else if (range === "all") {
                    inRange = true;
                }

                const matchesSearch = !searchTerm ||
                    (exp.source && exp.source.toLowerCase().includes(searchTerm)) ||
                    (exp.note && exp.note.toLowerCase().includes(searchTerm));

                return inRange && matchesSearch;
            });

            renderExpenses();
        }

        function renderExpenses() {
            const tbody = document.getElementById("expenses-table-body");
            if (!tbody) return;

            if (filteredExpenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center p-8 text-gray-500 dark:text-gray-400">
                            <i class="far fa-folder-open text-4xl mb-4"></i>
                            <p>לא נמצאו הוצאות בטווח זה</p>
                        </td>
                    </tr>
                `;
                document.getElementById("expensesCount").innerHTML = `<span>מוצגות</span> <span class="font-medium">0</span> <span>הוצאות</span>`;
                return;
            }

            tbody.innerHTML = filteredExpenses.map(item => {
                const date = item.rideDate?.toDate ? item.rideDate.toDate() : new Date(item.rideDate?.seconds ? item.rideDate.seconds * 1000 : item.rideDate);
                return `
                    <tr class="bg-red-50 dark:bg-red-900/20 animate-fade-in">
                        <td class="px-6 py-4">${date.toLocaleString("he-IL")}</td>
                        <td class="px-6 py-4">${item.source || ""}</td>
                        <td class="px-6 py-4">${item.note || item.destination || ""}</td>
                        <td class="px-6 py-4 text-red-700 font-bold">-₪${Math.abs(item.price || item.amount).toFixed(2)}</td>
                        <td class="px-6 py-4 text-center">
                            <button data-id="${item.id}" class="edit-expense-btn text-blue-600 hover:text-blue-800 p-2 transition clickable" title="ערוך הוצאה"><i class="fas fa-edit"></i></button>
                            <button data-id="${item.id}" class="delete-expense-btn text-red-600 hover:text-red-800 p-2 transition clickable" title="מחק הוצאה"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            }).join("");

            document.getElementById("expensesCount").innerHTML = `<span>מוצגות</span> <span class="font-medium">${filteredExpenses.length}</span> <span>הוצאות</span>`;

            document.querySelectorAll(".delete-expense-btn").forEach(btn => {
                btn.addEventListener("click", async e => {
                    const expenseId = e.currentTarget.dataset.id;
                    if (confirm("האם למחוק את ההוצאה?")) {
                        await deleteExpense(expenseId);
                    }
                });
            });
            
            document.querySelectorAll(".edit-expense-btn").forEach(btn => {
                btn.addEventListener("click", e => {
                    const expenseId = e.currentTarget.dataset.id;
                    const expense = allRides.find(r => r.id === expenseId && r.type === 'expense');
                    if (expense) openEditExpenseModal(expense);
                });
            });
        }

        function openEditExpenseModal(expense) {
    const expenseForm = document.getElementById("expenseForm");
    if (expenseForm) expenseForm.reset();

    const expenseTypeSelect = document.getElementById("expenseType");
    const customCategoryGroup = document.getElementById("customCategoryGroup");
    const customCategoryInput = document.getElementById("customCategory");

    // Check if this is a custom category (not one of the predefined types)
    const predefinedTypes = ["דלק", "ביטוח", "מוסך"];
    const isCustomCategory = ! predefinedTypes.includes(expense.source || "");

    if (isCustomCategory) {
        expenseTypeSelect.value = "הוצאה כללית";
        customCategoryGroup. classList.remove("hidden");
        customCategoryInput.required = true;
        customCategoryInput.value = expense.source || "";
    } else {
        expenseTypeSelect.value = expense.source || "";
        customCategoryGroup.classList.add("hidden");
        customCategoryInput.required = false;
        customCategoryInput.value = "";
    }

    document.getElementById("expenseAmount").value = Math.abs(expense.price || expense.amount || 0);
    document.getElementById("expenseNote").value = expense.destination || expense.note || "";
    document. getElementById("expenseId").value = expense.id;

    if (expenseDatePicker && expense.rideDate) {
        const date = expense.rideDate. toDate ?  expense.rideDate.toDate() : new Date(expense.rideDate. seconds ?  expense.rideDate.seconds * 1000 : expense.rideDate);
        expenseDatePicker. setDate(date);
    }

    if (expense.isFromRecurring || expense.recurringId) {
        document.getElementById("expenseKindRecurring").checked = true;
        document.getElementById("expenseKindOneTime").checked = false;
    } else {
        document.getElementById("expenseKindOneTime"). checked = true;
        document. getElementById("expenseKindRecurring").checked = false;
    }
    
    const modalTitle = document.querySelector("#expenseModal h3");
    if (modalTitle) modalTitle.textContent = "ערוך הוצאה";

    const expenseModal = document.getElementById("expenseModal");
    if (expenseModal) {
        expenseModal.classList.remove("hidden");
        expenseModal.classList.add("flex");
    }
}0000000000

    
        function attachTableEventListeners() {
            document.querySelectorAll(".edit-btn").forEach(btn => {
                btn.addEventListener("click", e => {
                    const ride = allRides.find(r => r.id === e.currentTarget.dataset.id);
                    if (ride) {
                        const modal = document.getElementById("paymentTypeModal");
                        if (modal) {
                            modal.classList.add("hidden");
                            modal.classList.remove("flex");
                        }
                        openEditModal(ride);
                    }
                });
            });

            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", e => openDeleteModal(e.currentTarget.dataset.id));
            });

            document.querySelectorAll(".delete-expense-btn").forEach(btn => {
                btn.addEventListener("click", async e => {
                    const expenseId = e.currentTarget.dataset.id;
                    if (confirm("האם למחוק את ההוצאה?")) {
                        await deleteExpense(expenseId);
                    }
                });
            });
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredRides.length / ridesPerPage);
            const totalPagesElement = document.getElementById("totalPages");
            const currentPageElement = document.getElementById("currentPage");
            const prevPageButton = document.getElementById("prevPage");
            const nextPageButton = document.getElementById("nextPage");

            if (totalPagesElement) totalPagesElement.textContent = totalPages;
            if (currentPageElement) currentPageElement.textContent = currentPage;
            if (prevPageButton) prevPageButton.disabled = currentPage === 1;
            if (nextPageButton) nextPageButton.disabled = currentPage >= totalPages;
        }

        function updateSummaryCards(rides, selectedDate) {
            const onlyRides = rides.filter(r => r.type !== 'expense');
            const onlyExpenses = rides.filter(r => r.type === 'expense');

            const todayRides = onlyRides.filter(r => {
                if (!r.rideDate) return false;
                const rideDate = r.rideDate.toDate ? r.rideDate.toDate() : new Date(r.rideDate.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                return rideDate.toDateString() === selectedDate.toDateString();
            });

            const todayExpenses = onlyExpenses.filter(r => {
                if (!r.rideDate) return false;
                const expenseDate = r.rideDate.toDate ? r.rideDate.toDate() : new Date(r.rideDate.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                return expenseDate.toDateString() === selectedDate.toDateString();
            });

            const previousDay = new Date(selectedDate);
            previousDay.setDate(previousDay.getDate() - 1);
            
            const previousDayRides = onlyRides.filter(r => {
                if (!r.rideDate) return false;
                const rideDate = r.rideDate.toDate ? r.rideDate.toDate() : new Date(r.rideDate.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                return rideDate.toDateString() === previousDay.toDateString();
            });

            const thisMonthRides = onlyRides.filter(r => {
                if (!r.rideDate) return false;
                const rideDate = r.rideDate.toDate ? r.rideDate.toDate() : new Date(r.rideDate.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                return rideDate.getMonth() === selectedDate.getMonth() && rideDate.getFullYear() === selectedDate.getFullYear();
            });

            const thisMonthExpenses = onlyExpenses.filter(r => {
                if (!r.rideDate) return false;
                const expenseDate = r.rideDate.toDate ? r.rideDate.toDate() : new Date(r.rideDate.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                return expenseDate.getMonth() === selectedDate.getMonth() && expenseDate.getFullYear() === selectedDate.getFullYear();
            });

            const previousMonth = new Date(selectedDate);
            previousMonth.setMonth(previousMonth.getMonth() - 1);
            
            const previousMonthRides = onlyRides.filter(r => {
                if (!r.rideDate) return false;
                const rideDate = r.rideDate.toDate ? r.rideDate.toDate() : new Date(r.rideDate.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                return rideDate.getMonth() === previousMonth.getMonth() && rideDate.getFullYear() === previousMonth.getFullYear();
            });

            const todayGross = todayRides.reduce((sum, r) => sum + (r.price || 0), 0);
            const todayNetBeforeExpenses = todayRides.reduce((sum, r) => sum + ((r.price || 0) - (r.commission || 0)), 0);
            const todayExpensesSum = todayExpenses.reduce((sum, r) => sum + Math.abs(r.price || 0), 0);
            const todayNetAfterExpenses = todayNetBeforeExpenses - todayExpensesSum;

            const monthGross = thisMonthRides.reduce((sum, r) => sum + (r.price || 0), 0);
            const monthNetBeforeExpenses = thisMonthRides.reduce((sum, r) => sum + ((r.price || 0) - (r.commission || 0)), 0);
            const monthExpensesSum = thisMonthExpenses.reduce((sum, r) => sum + Math.abs(r.price || 0), 0);
            const monthNetAfterExpenses = monthNetBeforeExpenses - monthExpensesSum;

            const previousDayGross = previousDayRides.reduce((sum, r) => sum + (r.price || 0), 0);
            const previousDayNetBeforeExpenses = previousDayRides.reduce((sum, r) => sum + ((r.price || 0) - (r.commission || 0)), 0);
            
            const previousMonthGross = previousMonthRides.reduce((sum, r) => sum + (r.price || 0), 0);
            const previousMonthNetBeforeExpenses = previousMonthRides.reduce((sum, r) => sum + ((r.price || 0) - (r.commission || 0)), 0);

            const alltimeNetProfit = onlyRides.reduce((sum, r) => sum + ((r.price || 0) - (r.commission || 0)), 0);
            const alltimeExpensesSum = onlyExpenses.reduce((sum, r) => sum + Math.abs(r.price || 0), 0);
            const alltimeNetProfitAfterExpenses = alltimeNetProfit - alltimeExpensesSum;

            const paymentTypes = ["מזומן", "ביט", "פייבוקס", "העברה בנקאית", "פתק"];
            const grossByPaymentType = { "מזומן": 0, "ביט": 0, "פייבוקס": 0, "העברה בנקאית": 0, "פתק": 0 };

            thisMonthRides.forEach(ride => {
                if (!ride.payment || !Array.isArray(ride.payment)) return;
                const gross = ride.price || 0;
                const totalPayments = ride.payment.reduce((s, p) => s + (p.amount || 0), 0) || 1;
                
                ride.payment.forEach(payment => {
                    if (paymentTypes.includes(payment.method)) {
                        grossByPaymentType[payment.method] += gross * ((payment.amount || 0) / totalPayments);
                    }
                });
            });

            const dailyRidesChange = calculatePercentageChange(todayRides.length, previousDayRides.length);
            const monthlyRidesChange = calculatePercentageChange(thisMonthRides.length, previousMonthRides.length);
            const dailyIncomeChange = calculatePercentageChange(todayGross, previousDayGross);
            const dailyNetChange = calculatePercentageChange(todayNetBeforeExpenses, previousDayNetBeforeExpenses);
            const monthlyIncomeChange = calculatePercentageChange(monthGross, previousMonthGross);
            const monthlyNetChange = calculatePercentageChange(monthNetBeforeExpenses, previousMonthNetBeforeExpenses);

            const setValue = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };

            setValue("daily-rides-count", todayRides.length);
            setValue("monthly-rides-count", thisMonthRides.length);

            setValue("daily-income", `₪${todayGross.toFixed(2)}`);
            setValue("daily-net-income-before-expenses", `₪${todayNetBeforeExpenses.toFixed(2)}`);
            setValue("daily-expenses-sum", `₪${todayExpensesSum.toFixed(2)}`);
            setValue("daily-net-income-after-expenses", `₪${todayNetAfterExpenses.toFixed(2)}`);

            setValue("monthly-income", `₪${monthGross.toFixed(2)}`);
            setValue("monthly-net-income-before-expenses", `₪${monthNetBeforeExpenses.toFixed(2)}`);
            setValue("monthly-expenses-sum", `₪${monthExpensesSum.toFixed(2)}`);
            setValue("monthly-net-income-after-expenses", `₪${monthNetAfterExpenses.toFixed(2)}`);

            setValue("monthly-cash-net", grossByPaymentType["מזומן"].toFixed(2));
            setValue("monthly-bit-net", grossByPaymentType["ביט"].toFixed(2));
            setValue("monthly-paybox-net", grossByPaymentType["פייבוקס"].toFixed(2));
            setValue("monthly-note-net", grossByPaymentType["פתק"].toFixed(2));
            setValue("monthly-bank-net", grossByPaymentType["העברה בנקאית"].toFixed(2));

            setValue("daily-expenses-count", todayExpenses.length);
            setValue("monthly-expenses-count", thisMonthExpenses.length);
            setValue("alltime-expenses-sum", `₪${alltimeExpensesSum.toFixed(2)}`);

            setValue("alltime-net-profit", `₪${alltimeNetProfit.toFixed(2)}`);
            setValue("alltime-net-profit-after-expenses", `₪${alltimeNetProfitAfterExpenses.toFixed(2)}`);

            updateChangeDisplay("daily-rides-change", dailyRidesChange);
            updateChangeDisplay("monthly-rides-change", monthlyRidesChange);
            updateChangeDisplay("daily-income-change", dailyIncomeChange);
            updateChangeDisplay("daily-net-change", dailyNetChange);
            updateChangeDisplay("monthly-income-change", monthlyIncomeChange);
            updateChangeDisplay("monthly-net-change", monthlyNetChange);
			updateGoalAndForecastWidget(monthGross, selectedDate);
        }

        function initSorting() {
            const sortBySelect = document.getElementById('sortBy');
            const sortOrderBtn = document.getElementById('sortOrder');
            const dateHeader = document.getElementById('dateHeader');
            const priceHeader = document.getElementById('priceHeader');
            
            if (sortBySelect) {
                sortBySelect.addEventListener('change', (e) => {
                    currentSortBy = e.target.value;
                    updateSortUI();
                    applySortAndFilter();
                });
            }
            
            if (sortOrderBtn) {
                sortOrderBtn.addEventListener('click', () => {
                    currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
                    updateSortUI();
                    applySortAndFilter();
                });
            }
            
            if (dateHeader) {
                dateHeader.addEventListener('click', () => {
                    if (currentSortBy === 'date') {
                        currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
                    } else {
                        currentSortBy = 'date';
                        currentSortOrder = 'desc';
                    }
                    document.getElementById('sortBy').value = 'date';
                    updateSortUI();
                    applySortAndFilter();
                });
            }
            
            if (priceHeader) {
                priceHeader.addEventListener('click', () => {
                    if (currentSortBy === 'price') {
                        currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
                    } else {
                        currentSortBy = 'price';
                        currentSortOrder = 'desc';
                    }
                    document.getElementById('sortBy').value = 'price';
                    updateSortUI();
                    applySortAndFilter();
                });
            }
        }

        function updateChangeDisplay(elementId, changePercent) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const isPositive = changePercent > 0;
            const isNeutral = Math.abs(changePercent) < 0.1;
            
            let icon, colorClass;
            
            if (isNeutral) {
                icon = '➡️';
                colorClass = 'text-gray-500 dark:text-gray-400';
            } else if (isPositive) {
                icon = '↗️';
                colorClass = 'text-green-600 dark:text-green-400';
            } else {
                icon = '↘️';
                colorClass = 'text-red-600 dark:text-red-400';
            }
            
            const displayText = isNeutral ? '0%' : `${isPositive ? '+' : ''}${changePercent.toFixed(1)}%`;
            
            element.innerHTML = `<span class="flex items-center gap-1"><span>${icon}</span><span>${displayText}</span></span>`;
            element.className = `font-medium ${colorClass}`;
        }
        
        function setValue(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }
        
        function calculatePercentageChange(current, previous) {
            if (previous === 0) {
                return current > 0 ? 100 : 0;
            }
            return ((current - previous) / previous) * 100;
        }

        function updateSortUI() {
            const sortOrderBtn = document.getElementById('sortOrder');
            const dateSortIcon = document.getElementById('dateSort');
            const priceSortIcon = document.getElementById('priceSort');
            
            if (sortOrderBtn) {
                const icon = sortOrderBtn.querySelector('i');
                const text = sortOrderBtn.querySelector('span');
                
                if (currentSortBy === 'date') {
                    if (currentSortOrder === 'desc') {
                        icon.className = 'fas fa-sort-amount-down';
                        if (text) text.textContent = 'חדש→ישן';
                    } else {
                        icon.className = 'fas fa-sort-amount-up';
                        if (text) text.textContent = 'ישן→חדש';
                    }
                } else {
                    if (currentSortOrder === 'desc') {
                        icon.className = 'fas fa-sort-amount-down';
                        if (text) text.textContent = 'גבוה→נמוך';
                    } else {
                        icon.className = 'fas fa-sort-amount-up';
                        if (text) text.textContent = 'נמוך→גבוה';
                    }
                }
            }
            
            if (dateSortIcon && priceSortIcon) {
                dateSortIcon.className = 'fas fa-sort text-gray-400 text-sm';
                priceSortIcon.className = 'fas fa-sort text-gray-400 text-sm';
                
                if (currentSortBy === 'date') {
                    dateSortIcon.className = currentSortOrder === 'desc' ? 'fas fa-sort-down text-primary-600 text-sm' : 'fas fa-sort-up text-primary-600 text-sm';
                } else {
                    priceSortIcon.className = currentSortOrder === 'desc' ? 'fas fa-sort-down text-primary-600 text-sm' : 'fas fa-sort-up text-primary-600 text-sm';
                }
            }
        }

        function sortRides(rides) {
            return rides.slice().sort((a, b) => {
                let comparison = 0;
                
                if (currentSortBy === 'date') {
                    const dateA = a.rideDate?.toDate ? a.rideDate.toDate() : new Date(a.rideDate?.seconds ? a.rideDate.seconds * 1000 : a.rideDate);
                    const dateB = b.rideDate?.toDate ? b.rideDate.toDate() : new Date(b.rideDate?.seconds ? b.rideDate.seconds * 1000 : b.rideDate);
                    comparison = dateA - dateB;
                } else if (currentSortBy === 'price') {
                    comparison = (a.price || 0) - (b.price || 0);
                }
                
                return currentSortOrder === 'desc' ? -comparison : comparison;
            });
        }

        function applySortAndFilter() {
            const selectedDate = datePicker?.selectedDates[0] || new Date();
            filterAndRenderRides(selectedDate);
            filterAndRenderExpenses(selectedDate);
        }

        function filterAndRenderRides(selectedDate = new Date()) {
    requestAnimationFrame(() => { // 🎯 Smooth rendering
        const searchTerm = document.getElementById("ridesSearch")?.value.toLowerCase() || "";
        const range = document.getElementById("ridesRange")?.value || "day";

        let filtered = allRides.filter(ride => {
            if (ride.type !== 'ride' || !ride.rideDate) return false;

            const rideDate = ride.rideDate?.toDate ? ride.rideDate.toDate() : new Date(ride.rideDate?.seconds ? ride.rideDate.seconds * 1000 : ride.rideDate);

            let inRange = false;
            if (range === "day") {
                inRange = rideDate.toDateString() === selectedDate.toDateString();
            } else if (range === "month") {
                inRange = rideDate.getMonth() === selectedDate.getMonth() && rideDate.getFullYear() === selectedDate.getFullYear();
            } else if (range === "all") {
                inRange = true;
            }

            const matchesSearch = !searchTerm ||
                (ride.source && ride.source.toLowerCase().includes(searchTerm)) ||
                (ride.destination && ride.destination.toLowerCase().includes(searchTerm)) ||
                (ride.customerPhone && ride.customerPhone.includes(searchTerm)) ||
                (ride.payment && ride.payment.some(p =>
                    (p.method && p.method.toLowerCase().includes(searchTerm)) ||
                    (p.note && p.note.toLowerCase().includes(searchTerm))
                ));

            return inRange && matchesSearch;
        });

        filtered = sortRides(filtered);
        filteredRides = filtered;
        currentPage = 1;
        renderRides();
        updatePagination();
        updateSortUI();
    }); // ✅ סגירה של requestAnimationFrame
}

        function updateDriverLevel(rides, selectedDate) {
            const thisMonthCount = rides.filter(r => {
                if (!r.rideDate) return false;
                const rideDate = r.rideDate.toDate ? r.rideDate.toDate() : new Date(r.rideDate.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                return rideDate.getMonth() === selectedDate.getMonth() && rideDate.getFullYear() === selectedDate.getFullYear();
            }).length;

            const container = document.getElementById("driver-level");
            if (!container) return;

            container.innerHTML = "";

            let levelText, iconClass, colorClass, tooltip;

            if (thisMonthCount >= 50) {
                levelText = "דרייבר ארגז 🏆";
                iconClass = "fas fa-medal";
                colorClass = "text-yellow-500";
                tooltip = "50+ נסיעות בחודש אלוף!";
            } else if (thisMonthCount >= 16) {
                levelText = "דרייבר איכותי ⭐";
                iconClass = "fas fa-star";
                colorClass = "text-blue-500";
                tooltip = "16-49 נסיעות בחודש - מצוין!";
            } else {
                levelText = "דרייבר מתחיל 🚀";
                iconClass = "fas fa-rocket";
                colorClass = "text-green-500";
                tooltip = "עד 15 נסיעות בחודש - בואו נתחיל!";
            }

            const levelBadge = document.createElement("div");
            levelBadge.className = `flex items-center gap-2 bg-white dark:bg-gray-800 px-3 py-2 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700`;
            levelBadge.innerHTML = `<i class="${iconClass} ${colorClass}"></i><span class="font-semibold text-gray-800 dark:text-gray-200">${levelText}</span>`;
            levelBadge.title = tooltip;

            container.appendChild(levelBadge);
        }

        let rideToDeleteId = null;

        function openAddModal() {
            const rideForm = document.getElementById("rideForm");
            const rideIdInput = document.getElementById("rideId");
            const paymentSplits = document.getElementById("payment-splits");
            
            if (rideForm) rideForm.reset();
            if (rideIdInput) rideIdInput.value = "";
            if (paymentSplits) paymentSplits.innerHTML = "";
            
            addPaymentRow();
            
            if (rideDateTimePicker) rideDateTimePicker.setDate(new Date());
            
            const modalTitle = document.getElementById("modalTitle");
            const modalSubtitle = document.getElementById("modalSubtitle");
            const submitBtnText = document.getElementById("submitBtnText");
            
            if (modalTitle) modalTitle.textContent = "הוסף נסיעה חדשה";
            if (modalSubtitle) modalSubtitle.textContent = "מלא את פרטי הנסיעה";
            if (submitBtnText) submitBtnText.textContent = "שמור נסיעה";
            
            const rideModal = document.getElementById("rideModal");
            if (rideModal) {
                rideModal.classList.remove("hidden");
                rideModal.classList.add("flex");
            }
            
            setTimeout(() => {
                const sourceInput = document.getElementById("source");
                if (sourceInput) sourceInput.focus();
            }, 100);
        }

        function openEditModal(ride) {
            const rideForm = document.getElementById("rideForm");
            if (rideForm) rideForm.reset();
            
            const modalTitle = document.getElementById("modalTitle");
            const modalSubtitle = document.getElementById("modalSubtitle");
            const submitBtnText = document.getElementById("submitBtnText");
            const rideIdInput = document.getElementById("rideId");
            
            if (modalTitle) modalTitle.textContent = "ערוך נסיעה";
            if (modalSubtitle) modalSubtitle.textContent = "עדכן את פרטי הנסיעה";
            if (submitBtnText) submitBtnText.textContent = "עדכן נסיעה";
            if (rideIdInput) rideIdInput.value = ride.id;

            const sourceInput = document.getElementById("source");
            const destinationInput = document.getElementById("destination");
            const priceInput = document.getElementById("price");
            const commissionInput = document.getElementById("commission");
            const customerPhoneInput = document.getElementById("customerPhone");
            if (sourceInput) sourceInput.value = ride.source || "";
            if (destinationInput) destinationInput.value = ride.destination || "";
            if (priceInput) priceInput.value = ride.price || "";
            if (commissionInput) commissionInput.value = ride.commission || "";
            if (customerPhoneInput) customerPhoneInput.value = ride.customerPhone || "";

            if (ride.rideDate && rideDateTimePicker) {
                const date = ride.rideDate.toDate ? ride.rideDate.toDate() : new Date(ride.rideDate.seconds ? ride.rideDate.seconds * 1000 : ride.rideDate);
                rideDateTimePicker.setDate(date);
            }

            const container = document.getElementById("payment-splits");
            if (container) {
                container.innerHTML = "";
                if (ride.payment && ride.payment.length > 0) {
                    ride.payment.forEach(payment => addPaymentRow(payment));
                } else {
                    addPaymentRow();
                }
            }

            const rideModal = document.getElementById("rideModal");
            if (rideModal) {
                rideModal.classList.remove("hidden");
                rideModal.classList.add("flex");
            }
            
            setTimeout(() => {
                const sourceInput = document.getElementById("source");
                if (sourceInput) sourceInput.focus();
            }, 100);
            
        }

        function closeModal() {
            const rideModal = document.getElementById("rideModal");
            if (rideModal) {
                rideModal.classList.add("hidden");
                rideModal.classList.remove("flex");
            }
        }

        function closeExpenseModal() {
            const expenseModal = document.getElementById("expenseModal");
            if (expenseModal) {
                expenseModal.classList.add("hidden");
                expenseModal.classList.remove("flex");
            }
        }

        function openDeleteModal(id) {
            rideToDeleteId = id;
            const deleteModal = document.getElementById("deleteModal");
            if (deleteModal) {
                deleteModal.classList.remove("hidden");
                deleteModal.classList.add("flex");
            }
        }

        function closeDeleteModal() {
            rideToDeleteId = null;
            const deleteModal = document.getElementById("deleteModal");
            if (deleteModal) {
                deleteModal.classList.add("hidden");
                deleteModal.classList.remove("flex");
            }
        }

        function openGlobalSearchModal() {
            const globalSearchModal = document.getElementById("globalSearchModal");
            if (globalSearchModal) {
                globalSearchModal.classList.remove("hidden");
                globalSearchModal.classList.add("flex");
            }
        }

        function closeGlobalSearchModal() {
            const globalSearchModal = document.getElementById("globalSearchModal");
            if (globalSearchModal) {
                globalSearchModal.classList.add("hidden");
                globalSearchModal.classList.remove("flex");
            }
        }

        function closeReportPreviewModal() {
            const reportPreviewModal = document.getElementById("reportPreviewModal");
            if (reportPreviewModal) {
                reportPreviewModal.classList.add("hidden");
                reportPreviewModal.classList.remove("flex");
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!ridesCollectionRef || !firebaseModules) return;

            const formData = {
                source: document.getElementById("source")?.value.trim() || "",
                destination: document.getElementById("destination")?.value.trim() || "",
                price: parseFloat(document.getElementById("price")?.value) || 0,
                commission: parseFloat(document.getElementById("commission")?.value) || 0,
                customerPhone: document.getElementById("customerPhone")?.value.trim() || "",
                rideDate: rideDateTimePicker?.selectedDates[0] ? firebaseModules.Timestamp.fromDate(rideDateTimePicker.selectedDates[0]) : firebaseModules.Timestamp.fromDate(new Date())
            };

            const missingFields = [];
            if (!formData.source) missingFields.push("מקור");
            if (!formData.destination) missingFields.push("יעד");
            if (!formData.price) missingFields.push("מחיר");
            if (!formData.commission && formData.commission !== 0) missingFields.push("עמלה");

            if (missingFields.length > 0) {
                const confirmSave = confirm(`חסרים הפרטים הבאים: ${missingFields.join(', ')}.\nהאם לשמור את הנסיעה בכל זאת?`);
                if (!confirmSave) return;
            }

            const paymentSplits = [];
            let totalPayment = 0;

            document.querySelectorAll("#payment-splits .payment-amount").forEach((input, i) => {
                const amount = parseFloat(input.value) || 0;
                if (amount > 0) {
                    const method = document.querySelectorAll(".payment-method")[i]?.value || "ביט";
                    const note = document.querySelectorAll(".payment-note")[i]?.value || "";
                    paymentSplits.push({
                        method,
                        amount,
                        note: method === "פתק" ? note : ""
                    });
                    totalPayment += amount;
                }
            });

            if (paymentSplits.length > 0 && Math.abs(totalPayment - formData.price) > 0.01) {
                showNotification(`סכום התשלומים (₪${totalPayment.toFixed(2)}) אינו תואם למחיר הנסיעה (₪${formData.price.toFixed(2)})`, 'error');
                return;
            }

            formData.payment = paymentSplits;
            formData.createdAt = firebaseModules.serverTimestamp();

            const rideId = document.getElementById("rideId")?.value;
            const isEdit = Boolean(rideId);
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.innerHTML : "";

            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> שומר...';
            }

            try {
                if (isEdit) {
                    await firebaseModules.updateDoc(firebaseModules.doc(db, `artifacts/${appId}/users/${userId}/rides`, rideId), formData);
                    showNotification("הנסיעה עודכנה בהצלחה!");
                } else {
                    await firebaseModules.addDoc(ridesCollectionRef, formData);
                    showNotification("הנסיעה נוספה בהצלחה!");
                }

                closeModal();
                await initializeAppData();
            } catch (error) {
                handleError(error, "שמירת נסיעה");
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
        }

        async function deleteRide(id) {
            if (!firebaseModules) return;
            try {
                await firebaseModules.deleteDoc(firebaseModules.doc(db, `artifacts/${appId}/users/${userId}/rides`, id));
                showNotification("הנסיעה נמחקה בהצלחה!");
                await initializeAppData();
            } catch (error) {
                handleError(error, "מחיקת נסיעה");
            }
        }

        async function deleteExpense(id) {
            if (!firebaseModules) return;
            try {
                await firebaseModules.deleteDoc(firebaseModules.doc(db, `artifacts/${appId}/users/${userId}/expenses`, id));
                showNotification("ההוצאה נמחקה בהצלחה!");
                await initializeAppData();
            } catch (error) {
                handleError(error, "מחיקת הוצאה");
            }
        }
        
        function displaySearchResults(results) {
            let html = "";
            
            if (results.length === 0) {
                html = `<div class="text-center text-gray-500 py-12"><i class="fas fa-search text-6xl mb-4 opacity-50"></i><p class="text-xl">לא נמצאו תוצאות</p></div>`;
            } else {
                html = `<table class="min-w-full border divide-y divide-gray-200 dark:divide-gray-700 rounded-lg"><thead class="bg-primary-600 dark:bg-primary-800 text-white"><tr><th class="py-3 px-4 font-semibold text-right">תאריך</th><th class="py-3 px-4 font-semibold text-right">סוג</th><th class="py-3 px-4 font-semibold text-right">מקור/סוג</th><th class="py-3 px-4 font-semibold text-right">יעד/הערה</th><th class="py-3 px-4 font-semibold text-right">פלאפון</th><th class="py-3 px-4 font-semibold text-right">סכום</th></tr></thead><tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-100 dark:divide-gray-800">${results.slice(0, 100).map(item => { const date = item.rideDate?.toDate ? item.rideDate.toDate() : new Date(item.rideDate?.seconds ? item.rideDate.seconds * 1000 : item.rideDate); const dateStr = date ? date.toLocaleDateString("he-IL") : ''; if (item.type === "expense") { return `<tr class="bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 transition"><td class="px-4 py-3 text-right">${dateStr}</td><td class="px-4 py-3 text-right"><span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"><i class="fas fa-receipt"></i> הוצאה</span></td><td class="px-4 py-3 text-right">${item.source || ""}</td><td class="px-4 py-3 text-right">${item.destination || item.note || ""}</td><td class="px-4 py-3 text-right">—</td><td class="px-4 py-3 text-right text-red-700 dark:text-red-400 font-bold">-₪${Math.abs(item.price).toFixed(2)}</td></tr>`; } return `<tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition"><td class="px-4 py-3 text-right">${dateStr}</td><td class="px-4 py-3 text-right"><span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200"><i class="fas fa-car-side"></i> נסיעה</span></td><td class="px-4 py-3 text-right">${item.source || ""}</td><td class="px-4 py-3 text-right">${item.destination || ""}</td><td class="px-4 py-3 text-right">${item.customerPhone || ""}</td><td class="px-4 py-3 text-right text-blue-700 dark:text-blue-300 font-semibold">₪${item.price?.toFixed(2) || ""}</td></tr>`; }).join("")}</tbody></table>`;
                if (results.length > 100) {
                    html += `<div class="text-xs text-gray-400 py-3 text-center">מוצגות 100 תוצאות ראשונות בלבד</div>`;
                }
            }
            
            const globalSearchResults = document.getElementById("globalSearchResults");
            if (globalSearchResults) {
                globalSearchResults.innerHTML = html;
            }
            openGlobalSearchModal();
        }

        function getFilteredRidesForReport() {
            const range = document.getElementById("reportRange")?.value || "all";
            const selectedDate = datePicker?.selectedDates?.[0] || new Date();
            const rides = allRides.filter(r => r.type !== "expense" && r.rideDate);

            if (range === "day") {
                return rides.filter(r => {
                    const rideDate = r.rideDate.toDate ? r.rideDate.toDate() : new Date(r.rideDate.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                    return rideDate.toDateString() === selectedDate.toDateString();
                });
            } else if (range === "month") {
                return rides.filter(r => {
                    const rideDate = r.rideDate.toDate ? r.rideDate.toDate() : new Date(r.rideDate.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                    return rideDate.getMonth() === selectedDate.getMonth() && rideDate.getFullYear() === selectedDate.getFullYear();
                });
            } else {
                return rides;
            }
        }

        function getFilteredRidesAndExpensesForReport() {
            const range = document.getElementById("reportRange")?.value || "all";
            const selectedDate = datePicker?.selectedDates?.[0] || new Date();
            
            return allRides.filter(r => {
                if (!r.rideDate) return false;
                
                const itemDate = r.rideDate.toDate ? r.rideDate.toDate() : new Date(r.rideDate.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                
                if (range === "day") {
                    return itemDate.toDateString() === selectedDate.toDateString();
                } else if (range === "month") {
                    return itemDate.getMonth() === selectedDate.getMonth() && itemDate.getFullYear() === selectedDate.getFullYear();
                } else {
                    return true;
                }
            });
        }

        function previewReport() {
            const items = getFilteredRidesAndExpensesForReport();
            
            if (items.length === 0) {
                showNotification("אין נתונים להצגה בתצוגה מקדימה", 'error');
                return;
            }

            const sortedItems = items.slice().sort((a, b) => {
                const dateA = a.rideDate?.toDate ? a.rideDate.toDate() : new Date(a.rideDate?.seconds ? a.rideDate.seconds * 1000 : a.rideDate);
                const dateB = b.rideDate?.toDate ? b.rideDate.toDate() : new Date(b.rideDate?.seconds ? b.rideDate.seconds * 1000 : b.rideDate);
                return dateB - dateA;
            });

            const totalGross = sortedItems.filter(r => r.type !== "expense").reduce((sum, r) => sum + (r.price || 0), 0);
            const totalNet = sortedItems.filter(r => r.type !== "expense").reduce((sum, r) => sum + ((r.price || 0) - (r.commission || 0)), 0);
            const totalExpenses = sortedItems.filter(r => r.type === "expense").reduce((sum, r) => sum + Math.abs(r.price), 0);
            const finalNet = totalNet - totalExpenses;

            const ridesOnly = sortedItems.filter(r => r.type !== "expense");

            const tableBody = sortedItems.map(item => {
                const date = item.rideDate?.toDate ? item.rideDate.toDate() : new Date(item.rideDate?.seconds ? item.rideDate.seconds * 1000 : item.rideDate);
                
                if (item.type === "expense") {
                    return `<tr class="bg-red-50 dark:bg-red-900/20"><td class="px-4 py-3 whitespace-nowrap text-red-700 dark:text-red-300 font-medium">${date.toLocaleString("he-IL")}</td><td class="px-4 py-3 whitespace-nowrap text-red-700 dark:text-red-300 font-medium">${item.source}</td><td class="px-4 py-3 whitespace-nowrap text-red-700 dark:text-red-300"></td><td class="px-4 py-3 whitespace-nowrap text-red-700 dark:text-red-300"></td><td class="px-4 py-3 whitespace-nowrap text-red-700 dark:text-red-300 font-bold">-₪${Math.abs(item.price).toFixed(2)}</td><td class="px-4 py-3 whitespace-nowrap text-red-700 dark:text-red-300">₪0.00</td><td class="px-4 py-3 whitespace-nowrap text-red-600 dark:text-red-400 font-bold">-₪${Math.abs(item.price).toFixed(2)}</td><td class="px-4 py-3 whitespace-nowrap text-red-700 dark:text-red-300">${item.destination || ''}</td><td class="px-4 py-3 whitespace-nowrap text-center"><span class="text-red-500 text-xs">הוצאה</span></td></tr>`;
                }
                
                const statusBadgeClass = item.paymentStatus === 'paid' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : item.paymentStatus === 'unpaid' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200';
                
                return `<tr class="hover:bg-primary-50 dark:hover:bg-gray-800 transition"><td class="px-4 py-3 whitespace-nowrap text-sm">${date.toLocaleString("he-IL")}</td><td class="px-4 py-3 whitespace-nowrap text-sm">${item.source}</td><td class="px-4 py-3 whitespace-nowrap text-sm">${item.destination}</td><td class="px-4 py-3 whitespace-nowrap text-sm">${item.customerPhone || ""}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-blue-700 dark:text-blue-300">₪${item.price?.toFixed(2) || ""}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-red-700 dark:text-red-400">₪${item.commission?.toFixed(2) || ""}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-green-700 dark:text-green-400">₪${(item.price - item.commission).toFixed(2)}</td><td class="px-4 py-3 whitespace-nowrap text-sm">${(item.payment || []).map(p => `<span class="inline-block bg-gray-100 dark:bg-gray-800 rounded px-2 py-1 mx-1 text-xs">${p.method}: ₪${p.amount.toFixed(2)}</span>`).join("")}</td><td class="px-4 py-3 whitespace-nowrap text-center"><span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${statusBadgeClass}">${item.paymentStatus === 'paid' ? '<i class="fas fa-check-circle"></i>' : item.paymentStatus === 'unpaid' ? '<i class="fas fa-times-circle"></i>' : '<i class="fas fa-minus-circle"></i>'} ${paymentStatusText}</span></td></tr>`;
            }).join("");

            const tableHtml = `<div class="overflow-x-auto"><table class="min-w-full border divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow"><thead class="bg-primary-600 dark:bg-primary-800 text-white"><tr><th class="py-3 px-4 font-semibold text-right">תאריך</th><th class="py-3 px-4 font-semibold text-right">מקור</th><th class="py-3 px-4 font-semibold text-right">יעד</th><th class="py-3 px-4 font-semibold text-right">פלאפון</th><th class="py-3 px-4 font-semibold text-right">מחיר</th><th class="py-3 px-4 font-semibold text-right">עמלה</th><th class="py-3 px-4 font-semibold text-right">נטו</th><th class="py-3 px-4 font-semibold text-right">תשלום/פירוט</th><th class="py-3 px-4 font-semibold text-right">סטטוס תותים</th></tr></thead><tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-100 dark:divide-gray-800">${tableBody}</tbody><tfoot><tr class="bg-primary-50 dark:bg-primary-900 font-bold text-base"><td colspan="5" class="py-4 px-4 text-right">סיכום נסיעות</td><td class="py-4 px-4 text-blue-700 dark:text-blue-300">₪${totalGross.toFixed(2)}</td><td></td><td class="py-4 px-4 text-green-700 dark:text-green-400">₪${totalNet.toFixed(2)}</td><td></td></tr><tr class="bg-red-100 dark:bg-red-900 font-bold text-base"><td colspan="7" class="py-4 px-4 text-right">סה"כ הוצאות</td><td class="py-4 px-4 text-red-700 dark:text-red-400">-₪${totalExpenses.toFixed(2)}</td><td></td></tr><tr class="bg-blue-100 dark:bg-blue-900 font-bold text-xl"><td colspan="7" class="py-4 px-4 text-right">נטו לאחר הוצאות</td><td class="py-4 px-4 text-blue-900 dark:text-blue-200">₪${finalNet.toFixed(2)}</td><td></td></tr><tr class="bg-green-50 dark:bg-green-900/50 border-t-2 border-green-300"><td colspan="9" class="py-4 px-4"><div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-sm"><div class="text-center"><div class="font-medium text-green-700 dark:text-green-300">נסיעות ששולמו</div><div class="text-lg font-bold text-green-800 dark:text-green-200">${paidRides.length}</div></div><div class="text-center"><div class="font-medium text-red-700 dark:text-red-300">נסיעות שלא שולמו</div><div class="text-lg font-bold text-red-800 dark:text-red-200">${unpaidRides.length}</div></div><div class="text-center"><div class="font-medium text-gray-700 dark:text-gray-300">לא צוין סטטוס</div><div class="text-lg font-bold text-gray-800 dark:text-gray-200">${unspecifiedRides.length}</div></div><div class="text-center"><div class="font-medium text-yellow-700 dark:text-yellow-300">בהמתנה לגביה</div><div class="text-lg font-bold text-yellow-800 dark:text-yellow-200">₪${unpaidAmount.toFixed(2)}</div></div></div></td></tr></tfoot></table></div>`;

            const reportTableContainer = document.getElementById("reportTableContainer");
            if (reportTableContainer) {
                reportTableContainer.innerHTML = tableHtml;
            }
            
            const reportPreviewModal = document.getElementById("reportPreviewModal");
            if (reportPreviewModal) {
                reportPreviewModal.classList.remove("hidden");
                reportPreviewModal.classList.add("flex");
            }
        }

        async function exportRides() {
            const rides = getFilteredRidesForReport();
            
            if (rides.length === 0) {
                showNotification("אין נסיעות לייצא", 'error');
                return;
            }

            if (typeof XLSX === "undefined") {
                showNotification("ספריית XLSX לא נטענה", 'error');
                return;
            }

            const rows = rides.map(r => {
                const date = r.rideDate?.toDate ? r.rideDate.toDate() : new Date(r.rideDate?.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                const paymentStatusText = r.paymentStatus === 'paid' ? 'שולם' : r.paymentStatus === 'unpaid' ? 'לא שולם' : 'לא צוין';
                
                return {
                    "תאריך": date.toLocaleString("he-IL"),
                    "מקור": r.source,
                    "יעד": r.destination,
                    "פלאפון": r.customerPhone || "",
                    "מחיר": r.price?.toFixed(2) || "",
                    "עמלה": r.commission?.toFixed(2) || "",
                    "נטו": ((r.price || 0) - (r.commission || 0)).toFixed(2),
                    "אמצעי תשלום": (r.payment || []).map(p => `${p.method}: ₪${p.amount.toFixed(2)}`).join(", ")
                };
            });

            try {
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "נסיעות");
                XLSX.writeFile(wb, `rides_report_${new Date().toISOString().split('T')[0]}.xlsx`);
                showNotification("הדוח יוצא בהצלחה!");
            } catch (error) {
                handleError(error, "ייצוא דוח");
            }
        }

        function resetAppState() {
            allRides = [];
            filteredRides = [];
            datesWithRides.clear();
            currentPage = 1;
			
			APP_CACHE.clear();
            
            const ridesTableBody = document.getElementById("rides-table-body");
            if (ridesTableBody) {
                ridesTableBody.innerHTML = `<tr><td colspan="9" class="text-center p-8 text-gray-500 dark:text-gray-400">התחבר כדי לראות נסיעות</td></tr>`;
            }
        }

        function showRateToast() {
            const toast = document.getElementById("rateToast");
            if (toast) {
                toast.classList.remove("hidden");
                setTimeout(() => toast.classList.add("hidden"), 5000);
            }
        }

        function setupEventListeners() {
            document.addEventListener("click", function(e) {
                if (e.target && e.target.id === "toggleAuth") {
                    e.preventDefault();
                    const isRegisterMode = document.getElementById("authTitle")?.textContent?.includes("הרשמה");
                    
                    const authTitle = document.getElementById("authTitle");
                    const authSubtitle = document.getElementById("authSubtitle");
                    const authSubmitText = document.getElementById("authSubmitText");
                    const authToggleText = document.getElementById("authToggleText");
                    
                    if (!isRegisterMode) {
                        if (authTitle) authTitle.textContent = "הרשמה למערכת";
                        if (authSubtitle) authSubtitle.textContent = "צור חשבון חדש";
                        if (authSubmitText) authSubmitText.textContent = "הרשם";
                        if (authToggleText) authToggleText.innerHTML = 'כבר רשום? <a href="#" id="toggleAuth" class="font-semibold text-primary-600 hover:text-primary-700 hover:underline transition">התחבר כאן</a>';
                    } else {
                        if (authTitle) authTitle.textContent = "התחבר למערכת";
                        if (authSubtitle) authSubtitle.textContent = "הכנס את פרטי החשבון שלך";
                        if (authSubmitText) authSubmitText.textContent = "התחבר";
                        if (authToggleText) authToggleText.innerHTML = 'אין לך משתמש? <a href="#" id="toggleAuth" class="font-semibold text-primary-600 hover:text-primary-700 hover:underline transition">הירשם כאן</a>';
                    }
                }
            });

            const themeToggleBtn = document.getElementById("themeToggle");
            if (themeToggleBtn) themeToggleBtn.addEventListener("click", toggleTheme);

            const addRideBtn = document.getElementById("addRideBtn");
            if (addRideBtn) addRideBtn.addEventListener("click", openAddModal);

            const calcBtn = document.getElementById("calcCommissionBtn");
            if (calcBtn) {
                calcBtn.addEventListener("click", function() {
                    const priceInput = document.getElementById("price");
                    const commissionInput = document.getElementById("commission");
                    if (!priceInput || !commissionInput) return;

                    const price = parseFloat(priceInput.value);
                    if (isNaN(price) || price <= 0) {
                        showNotification("אנא הזן קודם מחיר תקין לנסיעה", "error");
                        priceInput.focus();
                        return;
                    }
                    
                    const totalCommission = price * 0.12;
                    commissionInput.value = totalCommission.toFixed(2);
                    commissionInput.classList.add("input-success");
                    setTimeout(() => commissionInput.classList.remove("input-success"), 1500);
                });
            }

            const addPaymentBtn = document.getElementById("addPaymentBtn");
            if (addPaymentBtn) addPaymentBtn.addEventListener("click", () => addPaymentRow());

            const closeModalBtn = document.getElementById("closeModalBtn");
            if (closeModalBtn) closeModalBtn.addEventListener("click", closeModal);

            const closeExpenseModalBtn = document.getElementById("closeExpenseModalBtn");
            if (closeExpenseModalBtn) closeExpenseModalBtn.addEventListener("click", closeExpenseModal);

            const previewReportBtn = document.getElementById("previewReportBtn");
            if (previewReportBtn) previewReportBtn.addEventListener("click", previewReport);

            const exportRidesBtn = document.getElementById("exportRidesBtn");
            if (exportRidesBtn) exportRidesBtn.addEventListener("click", exportRides);

            const closePreviewReportBtn = document.getElementById("closePreviewReportBtn");
            if (closePreviewReportBtn) closePreviewReportBtn.addEventListener("click", closeReportPreviewModal);

            const closeGlobalSearchModalBtn = document.getElementById("closeGlobalSearchModal");
            if (closeGlobalSearchModalBtn) closeGlobalSearchModalBtn.addEventListener("click", closeGlobalSearchModal);

            const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
            if (cancelDeleteBtn) cancelDeleteBtn.addEventListener("click", closeDeleteModal);

            const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener("click", async () => {
                    if (rideToDeleteId) {
                        confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> מוחק...';
                        await deleteRide(rideToDeleteId);
                        closeDeleteModal();
                        confirmDeleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> מחק';
                    }
                });
            }

            const prevPageBtn = document.getElementById("prevPage");
            if (prevPageBtn) {
                prevPageBtn.addEventListener("click", () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderRides();
                        updatePagination();
                    }
                });
            }

            const nextPageBtn = document.getElementById("nextPage");
            if (nextPageBtn) {
                nextPageBtn.addEventListener("click", () => {
                    const totalPages = Math.ceil(filteredRides.length / ridesPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderRides();
                        updatePagination();
                    }
                });
            }

            const ridesSearch = document.getElementById("ridesSearch");
            if (ridesSearch) {
                ridesSearch.addEventListener("input", e => {
                    currentPage = 1;
                    applySortAndFilter();
                });
            }

            const expensesSearch = document.getElementById("expensesSearch");
            if (expensesSearch) {
                expensesSearch.addEventListener("input", () => {
                    const selectedDate = datePicker?.selectedDates[0] || new Date();
                    filterAndRenderExpenses(selectedDate);
                });
            }
            
            const ridesRange = document.getElementById("ridesRange");
            if (ridesRange) {
                ridesRange.addEventListener("change", () => {
                    const selectedDate = datePicker?.selectedDates[0] || new Date();
                    filterAndRenderRides(selectedDate);
                });
            }
            const expensesRange = document.getElementById("expensesRange");
            if (expensesRange) {
                expensesRange.addEventListener("change", () => {
                    const selectedDate = datePicker?.selectedDates[0] || new Date();
                    filterAndRenderExpenses(selectedDate);
                });
            }

            const rideForm = document.getElementById("rideForm");
            if (rideForm) rideForm.addEventListener("submit", handleFormSubmit);

           const expenseForm = document.getElementById("expenseForm");
if (expenseForm) {
    // Add event listener for expense type change
    const expenseTypeSelect = document.getElementById("expenseType");
    const customCategoryGroup = document.getElementById("customCategoryGroup");
    const customCategoryInput = document.getElementById("customCategory");

    if (expenseTypeSelect && customCategoryGroup && customCategoryInput) {
        expenseTypeSelect.addEventListener("change", function() {
            if (this.value === "הוצאה כללית") {
                customCategoryGroup.classList.remove("hidden");
                customCategoryInput.required = true;
            } else {
                customCategoryGroup.classList.add("hidden");
                customCategoryInput.required = false;
                customCategoryInput.value = "";
            }
        });
    }

    expenseForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const type = document.getElementById("expenseType")?.value;
        const customCategory = document.getElementById("customCategory")?.value?. trim();
        const amountStr = document.getElementById("expenseAmount")?.value;
        const note = document.getElementById("expenseNote")?.value || "";
        const date = expenseDatePicker?. selectedDates[0] || new Date();
        const expenseId = document.getElementById("expenseId")?.value;
        const isRecurringSelected = document.getElementById("expenseKindRecurring"). checked;
        
        let wasRecurring = false;
        let oldRecurringId = null;
        if (expenseId) {
            const currentExp = allRides.find(r => r.id === expenseId && r.type === "expense");
            wasRecurring = currentExp && (currentExp.isFromRecurring || currentExp.recurringId);
            oldRecurringId = currentExp && currentExp.recurringId;
        }

        if (! type || !amountStr) {
            showNotification("חובה למלא סוג הוצאה וסכום", 'error');
            return;
        }

        // Handle custom category for "הוצאה כללית"
        if (type === "הוצאה כללית" && ! customCategory) {
            showNotification("אנא הזן שם קטגוריה מותאמת", 'error');
            document.getElementById("customCategory").focus();
            return;
        }

        // Use custom category if "הוצאה כללית" is selected, otherwise use the selected type
        const finalExpenseType = type === "הוצאה כללית" ?  customCategory : type;

        const amount = parseFloat(amountStr);
        if (amount <= 0) {
            showNotification("סכום ההוצאה חייב להיות גדול מאפס", 'error');
            return;
        }

        if (! firebaseModules) {
            showNotification("Firebase לא אותחל", 'error');
            return;
        }

        const submitBtn = document.getElementById("expenseSubmitBtn");
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> שומר... ';
        }

        try {
            if (expenseId) {
                if (wasRecurring && ! isRecurringSelected) {
                    if (oldRecurringId) {
                        await firebaseModules.deleteDoc(firebaseModules.doc(db, `artifacts/${appId}/users/${userId}/recurringExpenses`, oldRecurringId));
                    }
                    await firebaseModules.updateDoc(firebaseModules.doc(db, `artifacts/${appId}/users/${userId}/expenses`, expenseId), { 
                        type: finalExpenseType, 
                        amount, 
                        note, 
                        expenseDate: firebaseModules. Timestamp.fromDate(date), 
                        isFromRecurring: false, 
                        recurringId: null, 
                        updatedAt: firebaseModules. serverTimestamp() 
                    });
                    showNotification("ההוצאה עודכנה לחד פעמית!");
                } else if (!wasRecurring && isRecurringSelected) {
                    const recurringRef = await firebaseModules.addDoc(firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/recurringExpenses`), { 
                        type: finalExpenseType, 
                        amount, 
                        note, 
                        startDate: firebaseModules. Timestamp.fromDate(date), 
                        createdAt: firebaseModules. serverTimestamp(), 
                        lastProcessed: null 
                    });
                    await firebaseModules.updateDoc(firebaseModules.doc(db, `artifacts/${appId}/users/${userId}/expenses`, expenseId), { 
                        type: finalExpenseType, 
                        amount, 
                        note: `${note} (הוצאה חודשית)`, 
                        expenseDate: firebaseModules.Timestamp.fromDate(date), 
                        isFromRecurring: true, 
                        recurringId: recurringRef.id, 
                        updatedAt: firebaseModules. serverTimestamp() 
                    });
                    showNotification("ההוצאה עודכנה לחודשית!");
                } else {
                    await firebaseModules.updateDoc(firebaseModules. doc(db, `artifacts/${appId}/users/${userId}/expenses`, expenseId), { 
                        type: finalExpenseType, 
                        amount, 
                        note: isRecurringSelected ? `${note} (הוצאה חודשית)` : note, 
                        expenseDate: firebaseModules.Timestamp.fromDate(date), 
                        isFromRecurring: isRecurringSelected, 
                        updatedAt: firebaseModules. serverTimestamp() 
                    });
                    showNotification("ההוצאה עודכנה בהצלחה!");
                }
            } else if (isRecurringSelected) {
                const recurringRef = await firebaseModules.addDoc(firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/recurringExpenses`), { 
                    type: finalExpenseType, 
                    amount, 
                    note, 
                    startDate: firebaseModules.Timestamp.fromDate(date), 
                    createdAt: firebaseModules. serverTimestamp(), 
                    lastProcessed: null 
                });
                await firebaseModules.addDoc(firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/expenses`), { 
                    type: finalExpenseType, 
                    amount, 
                    note: `${note} (הוצאה חודשית)`, 
                    expenseDate: firebaseModules.Timestamp.fromDate(date), 
                    isFromRecurring: true, 
                    recurringId: recurringRef.id, 
                    createdAt: firebaseModules. serverTimestamp() 
                });
                showNotification("הוצאה חודשית נוצרה בהצלחה!  תחזור אוטומטית כל חודש");
            } else {
                await firebaseModules.addDoc(firebaseModules.collection(db, `artifacts/${appId}/users/${userId}/expenses`), { 
                    type: finalExpenseType, 
                    amount, 
                    note, 
                    expenseDate: firebaseModules.Timestamp. fromDate(date), 
                    createdAt: firebaseModules. serverTimestamp() 
                });
                showNotification("ההוצאה נשמרה בהצלחה!");
            }

            closeExpenseModal();
            await initializeAppData();

        } catch (error) {
            handleError(error, "שמירת הוצאה");
        } finally {
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn. innerHTML = '<i class="fas fa-save"></i> <span id="expenseSubmitText">שמור הוצאה</span>';
            }
        }
    });
}           
            const authForm = document.getElementById("authForm");
            if (authForm) {
                authForm.addEventListener("submit", async e => {
                    e.preventDefault();
                    
                    const email = document.getElementById("email")?.value.trim();
                    const password = document.getElementById("password")?.value;
                    const isRegisterMode = document.getElementById("authTitle")?.textContent?.includes("הרשמה");

                    if (!email || !password) { showNotification("אנא מלא את כל השדות", 'error'); return; }
                    if (password.length < 6) { showNotification("הסיסמה חייבת להכיל לפחות 6 תווים", 'error'); return; }
                    if (!firebaseModules) { showNotification("Firebase לא אותחל", 'error'); return; }

                    const authSubmit = document.getElementById("authSubmit");
                    if (authSubmit) {
                        authSubmit.disabled = true;
                        authSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> טוען...';
                    }

                    try {
                        let cred;
                        if (isRegisterMode) {
                            cred = await firebaseModules.createUserWithEmailAndPassword(auth, email, password);
                            await firebaseModules.setDoc(firebaseModules.doc(db, "users", cred.user.uid), { email: email, status: "pending", createdAt: firebaseModules.serverTimestamp() });
                            showNotification("החשבון נוצר בהצלחה! ממתין לאישור מנהל");
                        } else {
                            cred = await firebaseModules.signInWithEmailAndPassword(auth, email, password);
                            showNotification("התחברת בהצלחה!");
                        }

                        const authModal = document.getElementById("authModal");
                        if (authModal) authModal.classList.add("hidden");
                    } catch (error) {
                        let errorMessage = "שגיאה לא מוכרת";
                        switch (error.code) {
                            case 'auth/user-not-found': errorMessage = "המשתמש לא קיים במערכת"; break;
                            case 'auth/wrong-password': errorMessage = "הסיסמה שגויה"; break;
                            case 'auth/email-already-in-use': errorMessage = "האימייל כבר קיים במערכת"; break;
                            case 'auth/invalid-email': errorMessage = "כתובת אימייל לא תקינה"; break;
                            case 'auth/weak-password': errorMessage = "הסיסמה חלשה מדי"; break;
                            default: errorMessage = error.message;
                        }
                        showNotification(errorMessage, 'error');
                    } finally {
                        if (authSubmit) {
                            authSubmit.disabled = false;
                            authSubmit.innerHTML = isRegisterMode ? '<i class="fas fa-user-plus"></i> הרשם' : '<i class="fas fa-sign-in-alt"></i> התחבר';
                        }
                    }
                });
            }

            const logoutBtn = document.getElementById("logoutBtn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", async () => {
                    if (!firebaseModules) return;
                    try {
                        await firebaseModules.signOut(auth);
                        showNotification("התנתקת בהצלחה!");
                    } catch (error) {
                        handleError(error, "התנתקות");
                    }
                });
            }

            const forgotPasswordLink = document.getElementById("forgotPasswordLink");
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener("click", async e => {
                    e.preventDefault();
                    const email = prompt("הכנס את כתובת האימייל שלך לקבלת קישור לאיפוס סיסמה:");
                    if (!email || !firebaseModules) return;

                    try {
                        await firebaseModules.sendPasswordResetEmail(auth, email);
                        showNotification("קישור לאיפוס סיסמה נשלח לאימייל שלך");
                    } catch (error) {
                        handleError(error, "איפוס סיסמה");
                    }
                });
            }

            const priceInput = document.getElementById("price");
            if (priceInput) priceInput.addEventListener("input", updatePaymentTotal);

            document.addEventListener("click", e => {
                if (e.target === document.getElementById("rideModal")) closeModal();
                if (e.target === document.getElementById("expenseModal")) closeExpenseModal();
                if (e.target === document.getElementById("deleteModal")) closeDeleteModal();
                if (e.target === document.getElementById("globalSearchModal")) closeGlobalSearchModal();
                if (e.target === document.getElementById("reportPreviewModal")) closeReportPreviewModal();
            });

            document.addEventListener("keydown", e => {
                if (e.key === "Escape") {
                    closeModal();
                    closeExpenseModal();
                    closeDeleteModal();
                    closeGlobalSearchModal();
                    closeReportPreviewModal();
                    closeExpenseMenu();
                }
            });
        }
// === Goals Feature Functions (FIXED) ===

// שמירת יעד חכם לחודש נוכחי (לפי שנה+חודש)
function saveSmartGoal(goalAmount, workDays) {
    // נוודא שתמיד יש תאריך
    const selectedDate = (datePicker && datePicker.selectedDates && datePicker.selectedDates[0])
        ? new Date(datePicker.selectedDates[0])
        : new Date();
    const key = `monthlyGoal_${selectedDate.getFullYear()}_${selectedDate.getMonth()}`;

    const goalData = {
        amount: goalAmount,
        workDays: workDays && workDays.length ? workDays : [0,1,2,3,4], // ברירת מחדל א'-ה'
        createdAt: new Date().toISOString()
    };

    localStorage.setItem(key, JSON.stringify(goalData));
    showNotification("היעד החודשי החכם נשמר בהצלחה! 🎯");

    const monthGross = calculateMonthlyGrossForDate(selectedDate);
    updateGoalAndForecastWidget(monthGross, selectedDate);
}

// טעינת יעד חכם לחודש נתון
function loadSmartGoal(date) {
    const d = date instanceof Date ? date : new Date(date);
    const key = `monthlyGoal_${d.getFullYear()}_${d.getMonth()}`;
    const saved = localStorage.getItem(key);

    if (saved) {
        try {
            return JSON.parse(saved);
        } catch (e) {
            // פורמט ישן (רק מספר)
            return {
                amount: parseFloat(saved),
                workDays: [0,1,2,3,4]
            };
        }
    }
    return null;
}

// האזנות לכפתורי יעד/ימי עבודה
function setupGoalEventListeners() {
    const saveBtn = document.getElementById('saveGoalBtn');
    const editBtn = document.getElementById('editGoalBtn');
    const goalInput = document.getElementById('goalInput');

    // toggle ימי עבודה
    document.querySelectorAll('.workday-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.classList.toggle('active');
            const icon = this.querySelector('i');
            icon.className = this.classList.contains('active') ? 'fas fa-check-circle' : 'fas fa-times-circle';
        });
    });

    if (saveBtn) {
        saveBtn.addEventListener('click', () => {
            const goalValue = parseFloat(goalInput.value);
            const workDays = getWorkDaysSelection();

            if (!goalValue || goalValue <= 0) {
                showNotification("יש להזין יעד חיובי", "error");
                return;
            }
            if (workDays.length === 0) {
                showNotification("יש לבחור לפחות יום עבודה אחד", "error");
                return;
            }

            saveSmartGoal(goalValue, workDays);
            document.getElementById('goalSetCard').classList.add('hidden');
            document.getElementById('goalDisplayCard').classList.remove('hidden');
        });
    }

    if (editBtn) {
        editBtn.addEventListener('click', () => {
            const selectedDate = datePicker?.selectedDates[0] || new Date();
            const goalData = loadSmartGoal(selectedDate);

            document.getElementById('goalDisplayCard').classList.add('hidden');
            document.getElementById('goalSetCard').classList.remove('hidden');

            if (goalData) {
                goalInput.value = goalData.amount;
                document.querySelectorAll('.workday-btn').forEach(btn => {
                    const day = parseInt(btn.dataset.day);
                    const icon = btn.querySelector('i');
                    if (goalData.workDays.includes(day)) {
                        btn.classList.add('active');
                        icon.className = 'fas fa-check-circle';
                    } else {
                        btn.classList.remove('active');
                        icon.className = 'fas fa-times-circle';
                    }
                });
            }
            goalInput.focus();
        });
    }
}

// עדכון כרטיס יעד + תחזית
function updateGoalAndForecastWidget(currentMonthGross, selectedDate) {
    const goalData = loadSmartGoal(selectedDate || new Date());

    if (!goalData || !goalData.amount) {
        document.getElementById('goalDisplayCard')?.classList.add('hidden');
        document.getElementById('goalSetCard')?.classList.remove('hidden');
        return;
    }

    const goalAmount = goalData.amount;
    const workDays = (goalData.workDays && goalData.workDays.length) ? goalData.workDays : [0,1,2,3,4];

    document.getElementById('goalDisplayCard')?.classList.remove('hidden');
    document.getElementById('goalSetCard')?.classList.add('hidden');

    const progress = Math.min((currentMonthGross / goalAmount) * 100, 100);
    const remaining = Math.max(goalAmount - currentMonthGross, 0);

    document.getElementById('goalProgressPercentage').textContent = `${Math.round(progress)}%`;
    document.getElementById('goalProgressBar').style.width = `${progress}%`;
    document.getElementById('goalCompleted').textContent = `₪${Math.round(currentMonthGross)}`;
    document.getElementById('goalRemaining').textContent = `₪${Math.round(remaining)}`;

    // תחזית חכמה לפי ממוצע לימי עבודה שכבר עברו
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const currentDay = today.getDate();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    let workDaysCompleted = 0;
    let totalWorkDaysInMonth = 0;
    for (let day = 1; day <= daysInMonth; day++) {
        const testDate = new Date(year, month, day);
        if (workDays.includes(testDate.getDay())) {
            totalWorkDaysInMonth++;
            if (day <= currentDay) workDaysCompleted++;
        }
    }

    const remainingWorkDays = totalWorkDaysInMonth - workDaysCompleted;
    const avgPerWorkDay = workDaysCompleted > 0 ? currentMonthGross / workDaysCompleted : 0;
    const forecastTotal = currentMonthGross + (avgPerWorkDay * remainingWorkDays);

    document.getElementById('goalForecast').textContent = `₪${Math.round(forecastTotal)}`;

    const breakdown = document.getElementById('forecastBreakdown');
    breakdown.innerHTML = `
        <div class="forecast-stat">
            <span class="forecast-stat-label"><i class="fas fa-chart-bar"></i> ממוצע ליום עבודה</span>
            <span class="forecast-stat-value">₪${Math.round(avgPerWorkDay)}</span>
        </div>
        <div class="forecast-stat">
            <span class="forecast-stat-label"><i class="fas fa-calendar-check"></i> ימי עבודה שעברו</span>
            <span class="forecast-stat-value">${workDaysCompleted}</span>
        </div>
        <div class="forecast-stat">
            <span class="forecast-stat-label"><i class="fas fa-calendar-plus"></i> ימי עבודה נותרים</span>
            <span class="forecast-stat-value">${remainingWorkDays}</span>
        </div>
        <div class="forecast-stat">
            <span class="forecast-stat-label"><i class="fas fa-bullseye"></i> נדרש ליום (ליעד)</span>
            <span class="forecast-stat-value">₪${remainingWorkDays > 0 ? Math.round(remaining / remainingWorkDays) : 0}</span>
        </div>
    `;

    const workDayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
    const selectedDays = workDays.map(d => workDayNames[d]).join(', ');
    document.getElementById('workDaysSummary').textContent = `עובד ${workDays.length} ימים: ${selectedDays}`;
}

// === Smart Goal System (helpers) ===

// בחירת ימי עבודה
function getWorkDaysSelection() {
    const selectedDays = [];
    document.querySelectorAll('.workday-btn.active').forEach(btn => {
        selectedDays.push(parseInt(btn.dataset.day));
    });
    return selectedDays;
}

// סכום ברוטו חודשי לפי Date
function calculateMonthlyGrossForDate(dateObj) {
    const d = dateObj instanceof Date ? dateObj : new Date(dateObj);
    return calculateMonthlyGrossByYearMonth(d.getFullYear(), d.getMonth());
}

// סכום ברוטו חודשי לפי שנה/חודש (Ride בלבד, ללא הוצאות)
function calculateMonthlyGrossByYearMonth(year, month) {
    try {
        const rides = allRides.filter(ride => {
            if (!ride.rideDate || ride.type === 'expense') return false;
            const rideDate = ride.rideDate instanceof Date
                ? ride.rideDate
                : ride.rideDate.toDate
                    ? ride.rideDate.toDate()
                    : ride.rideDate.seconds
                        ? new Date(ride.rideDate.seconds * 1000)
                        : new Date(ride.rideDate);
            if (isNaN(rideDate.getTime())) return false;
            return rideDate.getFullYear() === year && rideDate.getMonth() === month;
        });
        return rides.reduce((sum, ride) => sum + (parseFloat(ride.price) || 0), 0);
    } catch (error) {
        console.error('Error in calculateMonthlyGrossByYearMonth:', error);
        return 0;
    }
}

// (אופציונלי) חישוב ימי עבודה בחודש
function calculateWorkingDaysInMonth(year, month, workDays) {
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    let workingDaysCount = 0;
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        if (workDays.includes(date.getDay())) workingDaysCount++;
    }
    return workingDaysCount;
}

// (אופציונלי) תחזית ממוצעת — לא בשימוש ישיר כי אנו מחשבים ב-updateGoalAndForecastWidget
function calculateSmartForecast(currentAmount, date, workDays) {
    const today = new Date();
    const year = date.getFullYear();
    const month = date.getMonth();

    if (month !== today.getMonth() || year !== today.getFullYear()) {
        return { forecast: currentAmount, method: 'actual', details: null };
    }

    const currentDay = today.getDate();
    const totalWorkDays = calculateWorkingDaysInMonth(year, month, workDays);

    let workDaysPassed = 0;
    for (let day = 1; day <= currentDay; day++) {
        const d = new Date(year, month, day);
        if (workDays.includes(d.getDay())) workDaysPassed++;
    }

    if (workDaysPassed === 0) {
        return { forecast: 0, method: 'no_data', details: null };
    }

    const avgPerWorkDay = currentAmount / workDaysPassed;
    const forecast = avgPerWorkDay * totalWorkDays;

    return {
        forecast,
        method: 'smart',
        details: {
            avgPerWorkDay,
            workDaysPassed,
            totalWorkDays,
            workDaysRemaining: totalWorkDays - workDaysPassed
        }
    };
}

async function initApp() {
    try {
// בדיקה אם זה טעינה ראשונית או רענון
window.addEventListener('load', () => {
    // ✅ קודם כל בודקים אם זה רענון - ואז מוחקים מיד
    if (performance.navigation.type === 1) { // 1 = reload
        sessionStorage.removeItem('hasSeenWelcome');
    }
    
    // ✅ עכשיו קוראים את הערך (אחרי מחיקה אפשרית)
    const hasSeenWelcome = sessionStorage.getItem('hasSeenWelcome');
    
    if (!hasSeenWelcome) {
        sessionStorage.setItem('hasSeenWelcome', 'true');
        window.location.href = 'welcome-screen.html';
        return;
    }
});
        initializeTheme();
        const firebaseInitialized = await initializeFirebase();
        if (!firebaseInitialized) {
            showNotification("שגיאה באתחול Firebase", 'error');
            return;
        }
        setupDatePickers();
        setupEventListeners();
        setupGoalEventListeners();
        setupPaymentTypeCards();
        
        await loadChatbot();

        firebaseModules.onAuthStateChanged(auth, async user => {
            if (user) {
                try {
                    const userDoc = await firebaseModules.getDoc(firebaseModules.doc(db, "users", user.uid));
                    if (!userDoc.exists() || userDoc.data().status !== "approved") {
                        showNotification("החשבון שלך ממתין לאישור מנהל", 'error');
                        await firebaseModules.signOut(auth);
                        const authModal = document.getElementById("authModal");
                        if (authModal) authModal.classList.remove("hidden");
                        return;
                    }

                    userId = user.uid;
                    const logoutBtn = document.getElementById("logoutBtn");
                    if (logoutBtn) logoutBtn.classList.remove("hidden");
                    
                    const authModal = document.getElementById("authModal");
                    if (authModal) authModal.classList.add("hidden");
                    
                    await initializeAppData();
                } catch (error) {
                    handleError(error, "בדיקת הרשאות");
                    await firebaseModules.signOut(auth);
                }
            } else {
                userId = null;
                const logoutBtn = document.getElementById("logoutBtn");
                if (logoutBtn) logoutBtn.classList.add("hidden");
                
                const authModal = document.getElementById("authModal");
                if (authModal) authModal.classList.remove("hidden");
                
                resetAppState();
            }
        });
        
        setTimeout(() => {
            document.querySelectorAll(".card").forEach((card, index) => {
                card.classList.add("animate-fade-in");
                card.style.animationDelay = `${index * 0.1}s`;
            });
        }, 100);

        setTimeout(showRateToast, 6300);
        showNotification("המערכת נטענה בהצלחה!");
        
        // אלה צריכים להיות בתוך ה-try, לא מחוצה לו!
        initSorting();
        updateSortUI();
        
    } catch (error) {
        handleError(error, "אתחול המערכת");
    }
}
		
// Define driverChatBot globally so it's accessible
var driverChatBot;

async function loadChatbot() {
    try {
        // שלב 1: טען והזרק את ה-HTML של הצ'אט-בוט
        const response = await fetch('chatbot.html');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const html = await response.text();
        const container = document.getElementById('chatbot-container');
        container.innerHTML = html;
        console.log("Chatbot HTML loaded.");

        // שלב 2: צור תג סקריפט חדש כדי לטעון את chatbot.js
        const script = document.createElement('script');
        script.src = 'chatbot.js';
        
        // שלב 3: הפעל את פונקציית האתחול *אחרי* שהסקריפט נטען במלואו
        script.onload = () => {
            console.log("chatbot.js loaded.");
            if (typeof initializeDynamicChatbot === 'function') {
                initializeDynamicChatbot();
            } else {
                console.error("Critical: initializeDynamicChatbot function not found after script load!");
            }
        };
        
        // שלב 4: הוסף את הסקריפט לדף כדי שהדפדפן יטען וירץ אותו
        document.body.appendChild(script);

    } catch (error) {
        console.error("Could not load the chatbot:", error);
        document.getElementById('chatbot-container').innerHTML = '<p>Error loading chatbot.</p>';
    }
}
		
		function setupPaymentTypeCards() {
    const paymentTypes = [
        { id: "monthly-cash-net", label: "מזומן" },
        { id: "monthly-bit-net", label: "ביט" },
        { id: "monthly-paybox-net", label: "פייבוקס" },
        { id: "monthly-bank-net", label: "העברה בנקאית" },
        { id: "monthly-note-net", label: "פתק" }
    ];
    
    paymentTypes.forEach(pt => {
        const el = document.getElementById(pt.id)?.closest(".text-center");
        if (el) {
            el.classList.add("payment-type-card-clickable");
            el.style.position = "relative";
            el.onclick = () => openPaymentTypeModal(pt.label);
        }
    });
}
        
        function openPaymentTypeModal(paymentType) {
            document.getElementById("paymentTypeModalTitle").textContent = "נסיעות ששולמו ב" + paymentType;
            document.getElementById("paymentTypeModalSubtitle").textContent = "חודש " + getHebrewMonthName((datePicker?.selectedDates[0] || new Date()).getMonth()) + " " + (datePicker?.selectedDates[0] || new Date()).getFullYear();

            const selectedDate = datePicker?.selectedDates[0] || new Date();
            const filtered = allRides.filter(r => {
                if (r.type !== "ride" || !r.rideDate || !Array.isArray(r.payment)) return false;
                const rideDate = r.rideDate?.toDate ? r.rideDate.toDate() : new Date(r.rideDate?.seconds ? r.rideDate.seconds * 1000 : r.rideDate);
                const inMonth = rideDate.getMonth() === selectedDate.getMonth() && rideDate.getFullYear() === selectedDate.getFullYear();
                const paidByType = r.payment.some(p => p.method === paymentType);
                return inMonth && paidByType;
            });

            const contentDiv = document.getElementById("paymentTypeModalContent");
            if (!contentDiv) return;
            if (filtered.length === 0) {
                contentDiv.innerHTML = `<div class="text-center py-16 text-gray-500 dark:text-gray-400"><i class="fas fa-folder-open text-4xl mb-4"></i><div>לא נמצאו נסיעות ששולמו ב${paymentType} החודש</div></div>`;
                return;
            }

            contentDiv.innerHTML = `<div class="mb-3 text-center font-semibold text-xl text-blue-700 dark:text-blue-300">נמצאו ${filtered.length} נסיעות בסך <span class="font-bold">₪${filtered.reduce((sum, r) => sum + (r.price || 0), 0).toFixed(2)}</span></div><div class="divide-y divide-gray-200 dark:divide-gray-700">${filtered.map(r => { const d = r.rideDate?.toDate ? r.rideDate.toDate() : new Date(r.rideDate?.seconds ? r.rideDate.seconds * 1000 : r.rideDate); return `<div class="py-5 flex flex-col gap-2 animate-fade-in payment-type-ride-row clickable" data-ride-id="${r.id}"><div class="flex justify-between items-center"><span class="text-sm text-gray-500">${d.toLocaleDateString("he-IL")}</span><span class="text-lg font-bold text-blue-700 dark:text-blue-300">₪${r.price?.toFixed(2)}</span></div><div class="flex justify-between items-center text-sm"><span><i class="fas fa-arrow-left mx-1"></i>${r.source} → ${r.destination}</span><span class="text-gray-700 dark:text-gray-200">${r.customerPhone || ""}</span></div><div class="flex gap-2 mt-1 text-xs"><span class="bg-green-100 dark:bg-green-900 px-2 py-1 rounded text-green-700">${r.paymentStatus === "paid" ? "שולם" : r.paymentStatus === "unpaid" ? "לא שולם" : "לא צוין"}</span></div><div class="mt-2 text-xs text-primary-600"><i class="fas fa-eye"></i> לצפייה בפרטי נסיעה</div></div>`; }).join("")}</div>`;

            setTimeout(() => {
                document.querySelectorAll('.payment-type-ride-row').forEach(row => {
                    row.addEventListener('click', function() {
                        const rideId = this.getAttribute('data-ride-id');
                        const ride = allRides.find(r => r.id === rideId);
                        if (ride) {
                            const modal = document.getElementById("paymentTypeModal");
                            if (modal) {
                                modal.classList.add("hidden");
                                modal.classList.remove("flex");
                            }
                            openEditModal(ride);
                        }
                    });
                });
            }, 100);

            const modal = document.getElementById("paymentTypeModal");
            if (modal) {
                modal.classList.remove("hidden");
                modal.classList.add("flex");
            }
        }

function getHebrewMonthName(monthIdx) {
    const months = ["ינואר", "פברואר", "מרץ", "אפריל", "מאי", "יוני", "יולי", "אוגוסט", "ספטמבר", "אוקטובר", "נובמבר", "דצמבר"];
    return months[monthIdx] || "";
}

// Event listeners for payment modal
document.getElementById("closePaymentTypeModalBtn")?.addEventListener("click", () => {
    const modal = document.getElementById("paymentTypeModal");
    if (modal) {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }
});

document.getElementById("paymentTypeModal")?.addEventListener("click", e => {
    if (e.target === document.getElementById("paymentTypeModal")) {
        document.getElementById("paymentTypeModal").classList.add("hidden");
        document.getElementById("paymentTypeModal").classList.remove("flex");
    }
});

// Initialize app when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
} else {
    initApp();
}
    </script>
	<script>
// PWA Installation Support
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // הצג הודעת התקנה אחרי 5 שניות
    setTimeout(() => {
        const installBanner = document.createElement('div');
        installBanner.className = 'fixed bottom-4 left-4 right-4 bg-primary-600 text-white p-4 rounded-lg shadow-lg z-50 flex items-center justify-between animate-slide-up';
        installBanner.innerHTML = `
            <div class="flex items-center gap-3">
                <img src="logo.png" alt="לוגו" class="w-8 h-8">
                <span class="text-sm font-medium">התקן את האפליקציה בפלאפון שלך!</span>
            </div>
            <div class="flex gap-2">
                <button id="installBtn" class="bg-white text-primary-600 px-3 py-1 rounded font-medium text-sm hover:bg-gray-100 transition">
                    התקן
                </button>
                <button id="dismissBtn" class="text-white/80 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(installBanner);
        
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const result = await deferredPrompt.userChoice;
                if (result.outcome === 'accepted') {
                    showNotification('האפליקציה הותקנה בהצלחה! 🎉');
                }
                deferredPrompt = null;
                installBanner.remove();
            }
        });
        
        document.getElementById('dismissBtn').addEventListener('click', () => {
            installBanner.remove();
        });
        
        // הסר אוטומטית אחרי 15 שניות
        setTimeout(() => {
            if (document.body.contains(installBanner)) {
                installBanner.remove();
            }
        }, 15000);
        
    }, 5000);
});
</script>
</body>
</html>